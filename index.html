<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Program Piket OSIS - Material Design 3</title>
    <!-- Font Awesome (tetap digunakan untuk ikon) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Toastify CSS (tetap digunakan) -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <!-- Chart.js (tetap digunakan) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Roboto (MD3 Default) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- MD3 Inspired Variables & Base --- */
        :root {
            --md-sys-color-primary: #6750A4; /* Purple */
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005E;
            --md-sys-color-secondary: #625B71;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-on-secondary-container: #1E192B;
            --md-sys-color-tertiary: #7D5260;
            --md-sys-color-on-tertiary: #FFFFFF;
            --md-sys-color-tertiary-container: #FFD8E4;
            --md-sys-color-on-tertiary-container: #370B1E;
            --md-sys-color-error: #B3261E;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-error-container: #F9DEDC;
            --md-sys-color-on-error-container: #3E0500;
            --md-sys-color-background: #FFFBFE;
            --md-sys-color-on-background: #1C1B1F;
            --md-sys-color-surface: #FFFBFE; /* Similar to background for light theme */
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-surface-variant: #E7E0EC;
            --md-sys-color-on-surface-variant: #49454E;
            --md-sys-color-outline: #79747E;
            --md-sys-color-shadow: #000000;
            --md-sys-color-surface-container-highest: #E6E0E9; /* Card background */
            --md-sys-color-inverse-surface: #313033;
            --md-sys-color-inverse-on-surface: #F4EFF4;


            --md-ref-typeface-brand: 'Roboto', sans-serif;
            --md-ref-typeface-plain: 'Roboto', sans-serif;

            --md-sys-elevation-level-0: none;
            --md-sys-elevation-level-1: 0px 1px 3px 1px rgba(0, 0, 0, 0.15), 0px 1px 2px 0px rgba(0, 0, 0, 0.3);
            --md-sys-elevation-level-2: 0px 2px 6px 2px rgba(0, 0, 0, 0.15), 0px 1px 2px 0px rgba(0, 0, 0, 0.3);
            --md-sys-elevation-level-3: 0px 4px 8px 3px rgba(0, 0, 0, 0.15), 0px 1px 3px 0px rgba(0, 0, 0, 0.3);

            --md-sys-shape-corner-extra-small: 4px;
            --md-sys-shape-corner-small: 8px;
            --md-sys-shape-corner-medium: 12px;
            --md-sys-shape-corner-large: 16px;
            --md-sys-shape-corner-extra-large: 28px;
            --md-sys-shape-corner-full: 9999px; /* Pill shape */
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--md-ref-typeface-plain);
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            margin: 0;
            line-height: 1.5;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Dark Mode Variables */
        html[data-theme="dark"] {
            --md-sys-color-primary: #D0BCFF;
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-primary-container: #4F378B;
            --md-sys-color-on-primary-container: #EADDFF;
            --md-sys-color-secondary: #CCC2DC;
            --md-sys-color-on-secondary: #332D41;
            --md-sys-color-secondary-container: #4A4458;
            --md-sys-color-on-secondary-container: #E8DEF8;
            --md-sys-color-tertiary: #EFB8C8;
            --md-sys-color-on-tertiary: #492532;
            --md-sys-color-tertiary-container: #633B48;
            --md-sys-color-on-tertiary-container: #FFD8E4;
            --md-sys-color-error: #F2B8B5;
            --md-sys-color-on-error: #601410;
            --md-sys-color-error-container: #8C1D18;
            --md-sys-color-on-error-container: #F9DEDC;
            --md-sys-color-background: #1C1B1F;
            --md-sys-color-on-background: #E6E1E5;
            --md-sys-color-surface: #1C1B1F;
            --md-sys-color-on-surface: #E6E1E5;
            --md-sys-color-surface-variant: #49454E;
            --md-sys-color-on-surface-variant: #CAC4CF;
            --md-sys-color-outline: #938F99;
            --md-sys-color-surface-container-highest: #36343B; /* Card background dark */
            --md-sys-color-inverse-surface: #E6E1E5;
            --md-sys-color-inverse-on-surface: #313033;
        }


        /* Utility */
        .hidden { display: none !important; }
        .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;}
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        html[data-theme="dark"] .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--md-sys-color-outline); border-radius: 3px; }

        /* --- MD3 Component Styles --- */

        /* Buttons */
        .md-button {
            font-family: var(--md-ref-typeface-plain);
            font-weight: 500;
            font-size: 0.875rem; /* Label Large */
            letter-spacing: 0.00714em;
            padding: 0.625rem 1.5rem; /* 10px 24px */
            border-radius: var(--md-sys-shape-corner-full);
            border: none;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* 8px */
            min-height: 40px; /* MD3 spec */
            transition: background-color 0.2s, box-shadow 0.2s, opacity 0.2s;
            position: relative; /* For ripple/spinner */
            overflow: hidden; /* For ripple */
        }
        .md-button:disabled {
            cursor: not-allowed;
        }
        .md-button i:not(.button-spinner) { font-size: 1.125rem; /* 18px */ }


        .md-button--filled {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }
        .md-button--filled:hover:not(:disabled) {
            box-shadow: var(--md-sys-elevation-level-1);
        }
        .md-button--filled:disabled {
             background-color: var(--md-sys-color-on-surface);
             color: var(--md-sys-color-on-surface); 
             opacity: 0.12; 
        }
         html[data-theme="dark"] .md-button--filled:disabled {
             background-color: var(--md-sys-color-on-surface);
             color: var(--md-sys-color-on-surface);
             opacity: 0.12;
        }
        .md-button:disabled .button-text {
            opacity: 0.38;
        }
        html[data-theme="dark"] .md-button:disabled .button-text {
             color: var(--md-sys-color-on-surface); 
             opacity: 0.38;
        }


        .md-button--filled.danger { background-color: var(--md-sys-color-error); color: var(--md-sys-color-on-error); }
        .md-button--filled.secondary { background-color: var(--md-sys-color-secondary); color: var(--md-sys-color-on-secondary); }
        .md-button--filled.tertiary { background-color: var(--md-sys-color-tertiary); color: var(--md-sys-color-on-tertiary); }


        .md-button--outlined {
            background-color: transparent;
            color: var(--md-sys-color-primary);
            border: 1px solid var(--md-sys-color-outline);
        }
        .md-button--outlined:hover:not(:disabled) {
            background-color: rgba(103, 80, 164, 0.08); 
        }
         html[data-theme="dark"] .md-button--outlined:hover:not(:disabled) {
            background-color: rgba(208, 188, 255, 0.08); 
        }

        .md-button--outlined:disabled {
            border-color: rgba(28, 27, 31, 0.12); 
        }
         html[data-theme="dark"] .md-button--outlined:disabled {
            border-color: rgba(230,225,229, 0.12);
        }
        .md-button--outlined.danger { color: var(--md-sys-color-error); border-color: var(--md-sys-color-error); }
        .md-button--outlined.danger:hover:not(:disabled) { background-color: rgba(179, 38, 30, 0.08); }
         html[data-theme="dark"] .md-button--outlined.danger:hover:not(:disabled) { background-color: rgba(242, 184, 181, 0.08); }


        .md-button--text {
            background-color: transparent;
            color: var(--md-sys-color-primary);
            padding: 0.625rem 0.75rem;
        }
        .md-button--text:hover:not(:disabled) {
            background-color: rgba(103, 80, 164, 0.08);
        }
         html[data-theme="dark"] .md-button--text:hover:not(:disabled) {
            background-color: rgba(208, 188, 255, 0.08);
        }
        .md-button--text.danger { color: var(--md-sys-color-error); }
        .md-button--text.danger:hover:not(:disabled) { background-color: rgba(179, 38, 30, 0.08); }
         html[data-theme="dark"] .md-button--text.danger:hover:not(:disabled) { background-color: rgba(242, 184, 181, 0.08); }


        .md-icon-button {
            background-color: transparent;
            color: var(--md-sys-color-on-surface-variant);
            border: none;
            border-radius: var(--md-sys-shape-corner-full);
            width: 40px;
            height: 40px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .md-icon-button:hover:not(:disabled) {
            background-color: rgba(103, 80, 164, 0.08);
        }
         html[data-theme="dark"] .md-icon-button:hover:not(:disabled) {
            background-color: rgba(208, 188, 255, 0.08);
        }
        .md-icon-button i { font-size: 1.5rem; }


        /* Text Fields (Filled Style) */
        .md-textfield-container {
            position: relative;
            background-color: var(--md-sys-color-surface-container-highest);
            border-top-left-radius: var(--md-sys-shape-corner-extra-small);
            border-top-right-radius: var(--md-sys-shape-corner-extra-small);
            padding: 0.25rem 1rem 0; /* 4px 16px 0 */
            border-bottom: 1px solid var(--md-sys-color-on-surface-variant);
            transition: border-color 0.2s;
            margin-bottom: 1rem; /* Spacing */
        }
        .md-textfield-container:focus-within {
            border-bottom: 2px solid var(--md-sys-color-primary);
        }
         .md-textfield-container.error {
            border-bottom: 2px solid var(--md-sys-color-error) !important;
        }
        .md-textfield-label {
            display: block;
            font-size: 0.75rem; /* Body Small */
            color: var(--md-sys-color-on-surface-variant);
            padding-top: 0.25rem; /* 4px */
            transition: color 0.2s;
        }
        .md-textfield-container:focus-within .md-textfield-label {
            color: var(--md-sys-color-primary);
        }
        .md-textfield-container.error .md-textfield-label {
            color: var(--md-sys-color-error) !important;
        }

        .md-textfield {
            width: 100%;
            background-color: transparent;
            border: none;
            outline: none;
            font-size: 1rem; /* Body Large */
            color: var(--md-sys-color-on-surface);
            padding: 0.5rem 0 0.75rem; /* 8px 0 12px */
        }
        .md-textfield::placeholder {
            color: var(--md-sys-color-on-surface-variant);
            opacity: 0.7;
        }
        .md-textfield-supporting-text {
            font-size: 0.75rem;
            color: var(--md-sys-color-on-surface-variant);
            padding: 0.25rem 1rem 0;
            display: block;
        }
        .md-textfield-container.error .md-textfield-supporting-text {
             color: var(--md-sys-color-error);
        }

        /* Select (Styled like a TextField) */
        .md-select-container { /* Same as md-textfield-container */
            position: relative;
            background-color: var(--md-sys-color-surface-container-highest);
            border-top-left-radius: var(--md-sys-shape-corner-extra-small);
            border-top-right-radius: var(--md-sys-shape-corner-extra-small);
            padding: 0.25rem 1rem 0;
            border-bottom: 1px solid var(--md-sys-color-on-surface-variant);
            margin-bottom: 1rem;
            display: flex; /* To align icon */
            align-items: center; /* To align icon */
        }
        .md-select-container:focus-within {
            border-bottom: 2px solid var(--md-sys-color-primary);
        }
        .md-select-label { /* Same as md-textfield-label */
            display: block;
            font-size: 0.75rem;
            color: var(--md-sys-color-on-surface-variant);
            padding-top: 0.25rem;
            position: absolute; /* To allow select to be under it */
            top: 0.25rem;
            left: 1rem;
            pointer-events: none; /* So click goes to select */
        }
        .md-select {
            width: 100%;
            background-color: transparent;
            border: none;
            outline: none;
            font-size: 1rem;
            color: var(--md-sys-color-on-surface);
            padding: 1.25rem 0 0.75rem; /* Adjusted for label */
            appearance: none; /* Remove default arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
        }
        .md-select-container::after { /* Custom arrow */
            content: '\f078'; /* Font Awesome caret down */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--md-sys-color-on-surface-variant);
        }


        /* Cards */
        .md-card {
            background-color: var(--md-sys-color-surface-container-highest);
            border-radius: var(--md-sys-shape-corner-medium); /* 12px */
            box-shadow: var(--md-sys-elevation-level-1);
            padding: 1rem; /* 16px */
            margin-bottom: 1.5rem; /* 24px */
            overflow: hidden; /* If content inside might overflow */
        }
        .md-card__title {
            font-size: 1.375rem; /* Headline Small */
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 0.5rem;
        }
        .md-card__subtitle {
            font-size: 0.875rem; /* Title Medium */
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 1rem;
        }
        .md-card__content {
            color: var(--md-sys-color-on-surface-variant);
        }
        .md-card__actions {
            display: flex;
            justify-content: flex-end;
            padding-top: 1rem;
            gap: 0.5rem;
        }

        /* Tabs */
        .md-tabs {
            background-color: var(--md-sys-color-surface); /* Or primary container for some styles */
            box-shadow: var(--md-sys-elevation-level-1);
            margin-bottom: 1.5rem;
            border-radius: var(--md-sys-shape-corner-medium);
            overflow: hidden;
        }
        .md-tabs__list {
            display: flex;
            overflow-x: auto; /* For mobile */
            -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
            scrollbar-width: none; /* Hide scrollbar Firefox */
        }
        .md-tabs__list::-webkit-scrollbar { display: none; /* Hide scrollbar Chrome/Safari */ }

        .md-tabs__button {
            font-family: var(--md-ref-typeface-plain);
            font-weight: 500;
            font-size: 0.875rem; /* Title Small */
            color: var(--md-sys-color-on-surface-variant);
            padding: 0.75rem 1.5rem; /* 12px 24px */
            border: none;
            background-color: transparent;
            cursor: pointer;
            text-align: center;
            flex-shrink: 0; /* Prevent shrinking on mobile */
            position: relative;
            border-bottom: 2px solid transparent;
            transition: color 0.2s, border-color 0.2s;
            min-height: 48px; /* MD3 spec for tab height */
            display: inline-flex;
            align-items: center;
        }
        .md-tabs__button:hover {
            color: var(--md-sys-color-primary);
        }
        .md-tabs__button.active {
            color: var(--md-sys-color-primary);
            border-bottom-color: var(--md-sys-color-primary);
        }
        .md-tabs__button.active::after { /* Active indicator */
            /* No need for this after if using border-bottom */
        }
        .md-tab-content {
            padding: 0; /* Card will provide padding */
        }
        .md-tab-content.active {
            display: block;
        }


        /* Dialogs (Modals) */
        .md-dialog-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.32); /* Scrim */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0s 0.2s;
        }
        .md-dialog-overlay.visible {
            opacity: 1;
            visibility: visible;
            transition-delay: 0s;
        }
        .md-dialog {
            background-color: var(--md-sys-color-surface-container-highest);
            border-radius: var(--md-sys-shape-corner-extra-large); /* 28px */
            box-shadow: var(--md-sys-elevation-level-3);
            padding: 1.5rem; /* 24px */
            width: 90%;
            max-width: 560px; /* MD3 spec for wider dialogs */
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        }
        .md-dialog-overlay.visible .md-dialog {
            transform: scale(1);
            opacity: 1;
        }
        .md-dialog__icon { /* Optional */
            color: var(--md-sys-color-secondary);
            font-size: 1.5rem; /* 24px */
            text-align: center;
            margin-bottom: 1rem;
        }
        .md-dialog__title {
            font-size: 1.5rem; /* Headline Small */
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 1rem;
            text-align: center; /* Or left */
        }
        .md-dialog__content {
            font-size: 0.875rem; /* Body Medium */
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 1.5rem;
        }
        .md-dialog__actions {
            display: flex;
            justify-content: flex-end; /* Typically actions are on the right */
            gap: 0.5rem;
        }

        /* Lists (for schedule, attendance items) */
        .md-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem; /* 12px 16px */
            background-color: transparent; /* Let card handle bg */
            border-bottom: 1px solid var(--md-sys-color-outline); /* Divider */
            transition: background-color 0.2s;
        }
        .md-list-item:last-child { border-bottom: none; }
        .md-list-item:hover { background-color: rgba(var(--md-sys-color-primary-rgb, 103, 80, 164), 0.04); } /* Subtle hover */
         html[data-theme="dark"] .md-list-item:hover { background-color: rgba(208, 188, 255, 0.04); }


        .md-list-item__text {
            font-size: 1rem; /* Body Large */
            color: var(--md-sys-color-on-surface);
            flex-grow: 1;
        }
         .md-list-item__leading-icon {
            margin-right: 1rem;
            color: var(--md-sys-color-on-surface-variant);
        }
        .md-list-item__actions button { margin-left: 0.5rem; }


        /* Checkbox/Radio (Basic styling, true MD3 requires more complex SVG/JS) */
        input[type="checkbox"], input[type="radio"] {
            accent-color: var(--md-sys-color-primary); /* Modern browsers respect this */
            width: 1.25rem; height: 1.25rem;
            margin-right: 0.5rem;
            cursor: pointer;
            vertical-align: middle;
        }
        label.md-selection-label {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            color: var(--md-sys-color-on-surface);
            font-size: 0.875rem;
        }

        /* --- Application Specific Styles --- */

        /* Login Form */
        #login-form {
            /* Overlay handled by .md-dialog-overlay or similar */
        }
        #login-form > div { /* The card */
            background-color: var(--md-sys-color-surface-container-highest);
            border-radius: var(--md-sys-shape-corner-large);
            padding: 2rem;
            box-shadow: var(--md-sys-elevation-level-2);
            width: 90%;
            max-width: 400px;
        }
        #login-form h2 {
            font-size: 1.75rem; /* Headline Medium */
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            text-align: center;
        }
        #login-form #toggle-theme { margin-left: auto; }
        #login-error {
            color: var(--md-sys-color-error);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            text-align: center;
        }

        /* Main App Structure */
        #main-app header {
            background-color: var(--md-sys-color-surface); /* Top App Bar is surface */
            color: var(--md-sys-color-on-surface);
            box-shadow: var(--md-sys-elevation-level-2);
            padding: 0.75rem 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
         html[data-theme="dark"] #main-app header {
             background-color: var(--md-sys-color-surface-container-highest); /* Slightly different for dark */
         }

        #main-app header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px; margin: 0 auto;
        }
        #main-app header h1 {
            font-size: 1.375rem; /* Title Large */
            font-weight: 500;
        }
        #main-app main {
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Table Styling (Simplified MD-like) */
        table.md-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        table.md-table th, table.md-table td {
            text-align: left;
            padding: 0.75rem 1rem; /* 12px 16px */
            border-bottom: 1px solid var(--md-sys-color-outline);
            font-size: 0.875rem; /* Body Medium or Label Large */
        }
        table.md-table th {
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
        }
        table.md-table td {
            color: var(--md-sys-color-on-surface);
        }
        table.md-table tbody tr:hover {
            background-color: var(--md-sys-color-surface-variant);
            opacity: 0.8; /* Quick way for hover, or define specific hover color */
        }
        html[data-theme="dark"] table.md-table tbody tr:hover {
            background-color: rgba(var(--md-sys-color-on-surface-rgb,230,225,229), 0.08);
        }
        .table-actions button { /* Icon buttons in table */
            margin-right: 0.25rem;
            width: 32px; height: 32px; /* Smaller for table density */
        }
        .table-actions button i { font-size: 1rem; }


        /* Attendance Form Items */
        .attendance-item-md {
            background-color: var(--md-sys-color-surface-container-highest);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: var(--md-sys-elevation-level-1);
        }
        .attendance-item-md__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 0.5rem;
        }
        .attendance-item-md__name {
            font-size: 1rem; /* Title Medium */
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }
        .attendance-item-md__name.swapped-out {
            text-decoration: line-through;
            color: var(--md-sys-color-on-surface-variant);
        }
        .attendance-item-md__name.substitute {
            color: var(--md-sys-color-tertiary);
        }
        .attendance-item-md__status-text {
            font-size: 0.75rem;
            color: var(--md-sys-color-on-surface-variant);
        }
        .attendance-item-md__controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1rem;
        }
        .attendance-item-md__controls .md-selection-label { margin-right: 1rem; }
        .attendance-item-md__controls .reason-input-container {
            flex-grow: 1; /* Allow reason input to take space */
            min-width: 150px; /* Ensure it's not too small */
        }

        /* Button loading state specific styles */
        .md-button .button-icon-spinner-container {
            display: inline-flex;
            align-items: center;
            justify-content: center; /* Center icon/spinner */
            /* margin-right: 0.5em; Gap is handled by .md-button gap */
        }
        .md-button .button-spinner {
            display: none; /* Hidden by default */
            width: 1.125em; /* Match icon size */
            height: 1.125em; /* Match icon size */
            /* animation: spin 1s linear infinite; Spinner class already has this */
        }


        /* --- MOBILE OPTIMIZATIONS --- */
        @media (max-width: 768px) {
            #main-app header h1 { font-size: 1.125rem; /* Title Medium */ }
            .md-tabs__button { padding: 0.75rem 1rem; } /* Smaller padding for more tabs */

            .md-dialog {
                width: calc(100% - 2rem); /* Full width with margins */
                margin: 1rem;
                border-radius: var(--md-sys-shape-corner-large); /* Slightly less for mobile if preferred */
                max-height: 85vh;
            }
             .md-dialog__title { font-size: 1.25rem; }

            .table-responsive-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .attendance-item-md__controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem; /* Reduced gap for mobile */
            }
            .attendance-item-md__controls .md-textfield-container { width: 100%; }
            .attendance-item-md__controls .md-button { width: 100%; justify-content: center; } /* Full width buttons in stacked controls */

            /* Grid for schedule editor to stack */
            #schedule-tab .md-card > div[style*="grid-template-columns"], 
            #reports-tab .md-card > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            body { font-size: 0.95rem; } /* Slightly smaller base font */
            .md-button { padding: 0.625rem 1rem; font-size: 0.8rem; }
            .md-card { padding: 0.75rem; }
            .md-card__title { font-size: 1.125rem; }
             #login-form > div { padding: 1.5rem; }
             #login-form h2 { font-size: 1.5rem; }
        }

    </style>
</head>
<body> 
    <!-- Login Form -->
    <div id="login-form" class="md-dialog-overlay visible">
        <div> 
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 id="login-title-text">Program Piket OSIS</h2>
                <button id="toggle-theme" class="md-icon-button">
                    <i class="fas fa-moon"></i> <!-- Default: Moon (for light theme) -->
                    <i class="fas fa-sun hidden"></i> <!-- Sun (for dark theme) -->
                </button>
            </div>
            <form id="login-form-content" style="display: flex; flex-direction: column; gap: 1rem;">
                <div class="md-textfield-container">
                    <label for="username" class="md-textfield-label">Username</label>
                    <input type="text" id="username" name="username" placeholder="admin" required class="md-textfield">
                </div>
                <div class="md-textfield-container">
                    <label for="password" class="md-textfield-label">Password</label>
                    <input type="password" id="password" name="password" placeholder="admin123" required class="md-textfield">
                </div>
                <div id="login-error" class="md-textfield-supporting-text error hidden"></div>
                <button type="submit" id="login-submit-btn" class="md-button md-button--filled" style="width: 100%;" data-default-text="Login">
                     <span class="button-icon-spinner-container">
                        <!-- No default icon for login button, spinner will appear here -->
                        <i class="fas fa-spinner fa-spin button-spinner hidden"></i>
                    </span>
                    <span class="button-text">Login</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application (initially hidden) -->
    <div id="main-app" class="hidden">
        <header>
            <div class="container">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-calendar-check"></i>
                    <h1>Program Piket OSIS</h1>
                </div>
                <button id="logout-btn" class="md-button md-button--filled danger" data-default-text="Logout">
                     <span class="button-icon-spinner-container">
                        <i class="fas fa-sign-out-alt button-icon"></i>
                        <i class="fas fa-spinner fa-spin button-spinner hidden"></i>
                    </span>
                    <span class="button-text">Logout</span>
                </button>
            </div>
        </header>
        <main>
            <div class="md-tabs">
                <ul id="tabs" class="md-tabs__list">
                    <li><button data-tab="members" class="md-tabs__button active">Anggota</button></li>
                    <li><button data-tab="schedule" class="md-tabs__button">Jadwal</button></li>
                    <li><button data-tab="attendance" class="md-tabs__button">Absensi</button></li>
                    <li><button data-tab="reports" class="md-tabs__button">Laporan</button></li>
                    <li><button data-tab="data" class="md-tabs__button">Data</button></li>
                </ul>
            </div>
            <div>
                <div id="members-tab" class="md-tab-content active">
                    <div class="md-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem;">
                            <h2 class="md-card__title">Daftar Anggota OSIS</h2>
                            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                                <div class="md-textfield-container" style="margin-bottom: 0; min-width: 200px;">
                                    <label for="search-member" class="md-textfield-label visually-hidden">Cari Anggota</label>
                                    <input type="text" id="search-member" placeholder="Cari anggota..." class="md-textfield">
                                </div>
                                <button id="add-member-btn" class="md-button md-button--filled" data-default-text="Tambah Anggota">
                                    <span class="button-icon-spinner-container">
                                        <i class="fas fa-plus button-icon"></i>
                                        <i class="fas fa-spinner fa-spin button-spinner hidden"></i>
                                    </span>
                                    <span class="button-text">Tambah Anggota</span>
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive-container"><table class="md-table"><thead><tr><th>No</th><th>Nama Anggota</th><th>Aksi</th></tr></thead><tbody id="members-list"><tr id="members-loading-row"><td colspan="3" style="text-align:center; padding:1rem;">Memuat data...</td></tr></tbody></table></div>
                    </div>
                </div>
                <div id="schedule-tab" class="md-tab-content hidden">
                    <div class="md-card">
                        <h2 class="md-card__title">Jadwal Piket Mingguan</h2>
                        <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="md-select-container" style="min-width: 150px;"><label for="schedule-day-select" class="md-select-label">Pilih Hari</label><select id="schedule-day-select" class="md-select"><option value="Senin">Senin</option> <option value="Selasa">Selasa</option> <option value="Rabu">Rabu</option> <option value="Kamis">Kamis</option> <option value="Jumat">Jumat</option> <option value="Sabtu">Sabtu</option> <option value="Minggu">Minggu</option></select></div>
                            <button id="clear-day-schedule" class="md-button md-button--outlined danger" data-default-text="Hapus Jadwal Hari Ini"><span class="button-icon-spinner-container"><i class="fas fa-trash-alt button-icon"></i><i class="fas fa-spinner fa-spin button-spinner hidden"></i></span><span class="button-text">Hapus Jadwal Hari Ini</span></button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="md-card" style="margin-bottom:0;"><h3 class="md-card__subtitle">Anggota Tersedia</h3><div class="space-y-2 h-64 overflow-y-auto custom-scrollbar" id="available-members-schedule" style="min-height: 150px; padding: 0.5rem; border: 1px solid var(--md-sys-color-outline); border-radius: var(--md-sys-shape-corner-small);"><div style="text-align:center; padding:1rem; color: var(--md-sys-color-on-surface-variant);">Memuat...</div></div></div>
                            <div class="md-card" style="margin-bottom:0;"><h3 class="md-card__subtitle">Jadwal Piket <span id="selected-day-name-schedule">Senin</span></h3><div class="space-y-2 h-64 overflow-y-auto custom-scrollbar" id="scheduled-members-list" style="min-height: 150px; padding: 0.5rem; border: 1px solid var(--md-sys-color-outline); border-radius: var(--md-sys-shape-corner-small);"><div style="text-align:center; padding:1rem; color: var(--md-sys-color-on-surface-variant);">Memuat...</div></div></div>
                        </div>
                        <div class="md-card" style="margin-top:1.5rem;"><h3 class="md-card__subtitle">Jadwal Lengkap Minggu Ini</h3><div id="full-week-schedule-display" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar" style="padding: 0.5rem; border: 1px solid var(--md-sys-color-outline); border-radius: var(--md-sys-shape-corner-small);"><div style="text-align:center; padding:1rem; color: var(--md-sys-color-on-surface-variant);">Memuat...</div></div></div>
                    </div>
                </div>
                <div id="attendance-tab" class="md-tab-content hidden">
                    <div class="md-card">
                        <h2 class="md-card__title">Absensi Piket</h2>
                        <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="md-textfield-container" style="min-width: 200px; margin-bottom:0;"><label for="attendance-date" class="md-textfield-label">Tanggal Absensi</label><input type="date" id="attendance-date" class="md-textfield"></div>
                            <button id="load-attendance" class="md-button md-button--filled" data-default-text="Muat Jadwal"><span class="button-icon-spinner-container"><i class="fas fa-calendar-day button-icon"></i><i class="fas fa-spinner fa-spin button-spinner hidden"></i></span><span class="button-text">Muat Jadwal</span></button>
                        </div>
                        <div id="no-schedule-attendance" class="text-center py-8 hidden" style="color: var(--md-sys-color-on-surface-variant);"><i class="fas fa-calendar-times" style="font-size: 2.5rem; margin-bottom: 0.5rem;"></i><p>Tidak ada jadwal piket untuk tanggal ini.</p></div>
                        <div id="attendance-form-container" class="hidden">
                            <h3 class="md-card__subtitle">Daftar Kehadiran untuk <span id="attendance-date-display"></span> (<span id="attendance-day-display"></span>)</h3>
                            <div id="attendance-list" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
                            <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end;">
                                <button id="save-attendance" class="md-button md-button--filled" data-default-text="Simpan Perubahan">
                                    <span class="button-icon-spinner-container">
                                        <i class="fas fa-save button-icon"></i>
                                        <i class="fas fa-spinner fa-spin button-spinner hidden"></i>
                                    </span>
                                    <span class="button-text">Simpan Perubahan</span>
                                </button>
                            </div>
                        </div>
                        <div id="attendance-status-summary" class="md-card" style="margin-top: 1.5rem;"><p style="color: var(--md-sys-color-on-surface-variant);">Status kehadiran akan muncul di sini.</p></div>
                    </div>
                </div>
                <div id="reports-tab" class="md-tab-content hidden">
                     <div class="md-card">
                        <h2 class="md-card__title">Laporan & Statistik</h2>
                        <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; align-items: flex-end;">
                            <div class="md-select-container" style="min-width: 150px; margin-bottom:0;"><label for="report-month" class="md-select-label">Bulan</label><select id="report-month" class="md-select"><option value="1">Januari</option> <option value="2">Februari</option> <option value="3">Maret</option> <option value="4">April</option> <option value="5">Mei</option> <option value="6">Juni</option> <option value="7">Juli</option> <option value="8">Agustus</option> <option value="9">September</option> <option value="10">Oktober</option> <option value="11">November</option> <option value="12">Desember</option></select></div>
                            <div class="md-select-container" style="min-width: 120px; margin-bottom:0;"><label for="report-year" class="md-select-label">Tahun</label><select id="report-year" class="md-select"></select></div>
                            <button id="generate-report" class="md-button md-button--filled" data-default-text="Hasilkan Laporan"><span class="button-icon-spinner-container"><i class="fas fa-chart-line button-icon"></i><i class="fas fa-spinner fa-spin button-spinner hidden"></i></span><span class="button-text">Hasilkan Laporan</span></button>
                            <button id="export-report" class="md-button md-button--outlined" data-default-text="Ekspor CSV"><span class="button-icon-spinner-container"><i class="fas fa-file-csv button-icon"></i><i class="fas fa-spinner fa-spin button-spinner hidden"></i></span><span class="button-text">Ekspor CSV</span></button>
                        </div>
                        <div id="report-results-container">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                                <div class="md-card"><h3 class="md-card__subtitle">Penghargaan Bulanan</h3><div id="monthly-award-display" style="color: var(--md-sys-color-on-surface-variant);">Pilih bulan dan tahun.</div></div>
                                <div class="md-card"><h3 class="md-card__subtitle">Statistik Kehadiran Umum</h3><div style="height: 250px;"><canvas id="overall-attendance-chart"></canvas></div></div>
                            </div>
                            <div class="md-card" style="margin-top: 1.5rem;"><h3 class="md-card__subtitle">Detail Partisipasi Anggota (<span id="report-month-year-display"></span>)</h3><div class="table-responsive-container"><table class="md-table"><thead><tr><th>Nama</th><th>Dijadwalkan</th><th>Hadir</th><th>Absen</th><th>Digantikan</th><th>Menggantikan</th><th>% Hadir</th></tr></thead><tbody id="participation-details-table"><tr><td colspan="7" style="text-align:center; padding:1rem; color: var(--md-sys-color-on-surface-variant);">Pilih bulan dan tahun.</td></tr></tbody></table></div></div>
                        </div>
                    </div>
                </div>
                <div id="data-tab" class="md-tab-content hidden">
                    <div class="md-card">
                        <h2 class="md-card__title">Kelola Data</h2>
                        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                            <div class="md-card"><h3 class="md-card__subtitle">Cadangkan Data</h3><p style="color: var(--md-sys-color-on-surface-variant); margin-bottom: 1rem;">Salin data ini untuk backup.</p><div class="md-textfield-container" style="background-color: var(--md-sys-color-surface);"><label for="backup-data-textarea" class="md-textfield-label visually-hidden">Data Backup</label><textarea id="backup-data-textarea" class="md-textfield" style="min-height: 100px; resize: vertical;" readonly placeholder="Klik 'Buat Backup'..."></textarea></div><div class="md-card__actions"><button id="create-backup-btn" class="md-button md-button--filled" data-default-text="Buat Backup"><span class="button-icon-spinner-container"><i class="fas fa-download button-icon"></i><i class="fas fa-spinner fa-spin button-spinner hidden"></i></span><span class="button-text">Buat Backup</span></button><button id="copy-backup-btn" class="md-button md-button--outlined hidden" data-default-text="Salin"><span class="button-icon-spinner-container"><i class="fas fa-copy button-icon"></i><i class="fas fa-spinner fa-spin button-spinner hidden"></i></span><span class="button-text">Salin</span></button></div></div>
                            <div class="md-card"><h3 class="md-card__subtitle">Pulihkan Data</h3><p style="color: var(--md-sys-color-on-surface-variant); margin-bottom: 1rem;">Tempel data JSON. <strong style="color: var(--md-sys-color-error);">PERHATIAN: Timpa data!</strong></p><div class="md-textfield-container" style="background-color: var(--md-sys-color-surface);"><label for="restore-data-textarea" class="md-textfield-label visually-hidden">Data Restore</label><textarea id="restore-data-textarea" class="md-textfield" style="min-height: 100px; resize: vertical;" placeholder="Tempel JSON..."></textarea></div><div class="md-card__actions"><button id="confirm-restore-btn" class="md-button md-button--filled tertiary" data-default-text="Pulihkan"><span class="button-icon-spinner-container"><i class="fas fa-upload button-icon"></i><i class="fas fa-spinner fa-spin button-spinner hidden"></i></span><span class="button-text">Pulihkan</span></button></div></div>
                            <div class="md-card" style="background-color: var(--md-sys-color-error-container);"><h3 class="md-card__subtitle" style="color: var(--md-sys-color-on-error-container);">Reset Data Aplikasi</h3><p style="color: var(--md-sys-color-on-error-container); margin-bottom: 1rem;">Hapus semua data. <strong class="uppercase">Hati-hati!</strong></p><div class="md-card__actions"><button id="reset-app-confirm-btn" class="md-button md-button--filled danger" data-default-text="Reset Semua Data"><span class="button-icon-spinner-container"><i class="fas fa-exclamation-triangle button-icon"></i><i class="fas fa-spinner fa-spin button-spinner hidden"></i></span><span class="button-text">Reset Semua Data</span></button></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="member-modal" class="md-dialog-overlay hidden"><div class="md-dialog"><h3 class="md-dialog__title" id="member-modal-title"></h3><div class="md-dialog__content"><input type="hidden" id="member-id-input"><div class="md-textfield-container"><label for="member-name-input" class="md-textfield-label">Nama Anggota</label><input type="text" id="member-name-input" class="md-textfield"></div><p id="member-name-error" class="md-textfield-supporting-text error hidden">Nama harus diisi.</p></div><div class="md-dialog__actions"><button type="button" id="cancel-member-btn" class="md-button md-button--text">Batal</button><button type="button" id="save-member-btn" class="md-button md-button--filled" data-default-text="Simpan"><span class="button-icon-spinner-container"><i class="fas fa-save button-icon"></i><i class="fas fa-spinner fa-spin button-spinner hidden"></i></span><span class="button-text">Simpan</span></button></div></div></div>
    <div id="swap-duty-modal" class="md-dialog-overlay hidden"><div class="md-dialog"><h3 class="md-dialog__title">Gantikan Piket <strong id="swap-modal-original-member-name"></strong></h3><div class="md-dialog__content"><p style="font-size: 0.875rem; color: var(--md-sys-color-on-surface-variant); margin-bottom:1rem;">Tanggal: <span id="swap-modal-date-display"></span></p><input type="hidden" id="swap-original-member-id"><input type="hidden" id="swap-attendance-date-hidden"><div class="md-select-container" style="margin-bottom:1rem;"><label for="swap-member-select" class="md-select-label">Pilih Pengganti</label><select id="swap-member-select" class="md-select"></select></div><div class="md-textfield-container"><label for="swap-reason-input" class="md-textfield-label">Alasan (Opsional)</label><input type="text" id="swap-reason-input" class="md-textfield" placeholder="Mis: Sakit"></div></div><div class="md-dialog__actions"><button type="button" id="cancel-swap-btn" class="md-button md-button--text">Batal</button><button type="button" id="confirm-swap-btn" class="md-button md-button--filled" data-default-text="Konfirmasi"><span class="button-icon-spinner-container"><i class="fas fa-check button-icon"></i><i class="fas fa-spinner fa-spin button-spinner hidden"></i></span><span class="button-text">Konfirmasi</span></button></div></div></div>
    <div id="reset-data-modal" class="md-dialog-overlay hidden"><div class="md-dialog"><div class="md-dialog__icon"><i class="fas fa-exclamation-triangle" style="color: var(--md-sys-color-error);"></i></div><h3 class="md-dialog__title" id="reset-modal-title">Konfirmasi Reset</h3><div class="md-dialog__content"><p id="reset-modal-message">Yakin reset semua data? Tidak bisa dibatalkan.</p></div><div class="md-dialog__actions"><button type="button" id="cancel-reset-action-btn" class="md-button md-button--text">Batal</button><button type="button" id="confirm-reset-action-btn" class="md-button md-button--filled danger" data-default-text="Ya, Reset"><span class="button-icon-spinner-container"><i class="fas fa-trash-alt button-icon"></i><i class="fas fa-spinner fa-spin button-spinner hidden"></i></span><span class="button-text">Ya, Reset</span></button></div></div></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script type="module">
        // --- Firebase Configuration (WAJIB GANTI!) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAsBHJoii6RBGrslUH31ix1AyLheRm6HS4",
            authDomain: "piketosis.firebaseapp.com",
            projectId: "piketosis",
            storageBucket: "piketosis.firebasestorage.app",
            messagingSenderId: "341698253309",
            appId: "1:341698253309:web:a5ea2d83768348a7f9c994",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- DOM Elements ---
        const loginFormEl = document.getElementById('login-form');
        const mainAppEl = document.getElementById('main-app');
        const loginFormContentEl = document.getElementById('login-form-content');
        const usernameInputEl = document.getElementById('username');
        const passwordInputEl = document.getElementById('password');
        const loginErrorEl = document.getElementById('login-error');
        const loginSubmitBtn = document.getElementById('login-submit-btn');
        const logoutBtnEl = document.getElementById('logout-btn');
        const htmlEl = document.documentElement;
        const toggleThemeBtnEl = document.getElementById('toggle-theme');
        
        // Global state
        let membersCache = []; 
        let schedulesCache = {}; 
        let attendanceCache = {}; 
        let overallAttendanceChartInstance = null;
        const daysOfWeek = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
        const monthsIndonesian = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

        // --- LOGIN & THEME ---
        loginFormContentEl.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = usernameInputEl.value.trim();
            const password = passwordInputEl.value.trim();
            setButtonLoadingState(loginSubmitBtn, true, "Login");
            
            setTimeout(() => { 
                if (username === 'admin' && password === 'admin123') {
                    loginErrorEl.classList.add('hidden');
                    loginFormEl.classList.remove('visible');
                    loginFormEl.classList.add('hidden');
                    mainAppEl.classList.remove('hidden');
                    initializeApp();
                } else {
                    loginErrorEl.textContent = 'Username atau password salah.';
                    loginErrorEl.classList.remove('hidden');
                }
                setButtonLoadingState(loginSubmitBtn, false);
            }, 500);
        });
        
        logoutBtnEl.addEventListener('click', () => {
            setButtonLoadingState(logoutBtnEl, true, "Logout");
            setTimeout(() => { 
                mainAppEl.classList.add('hidden');
                loginFormEl.classList.add('visible');
                loginFormEl.classList.remove('hidden');
                usernameInputEl.value = '';
                passwordInputEl.value = '';
                loginErrorEl.classList.add('hidden');
                membersCache = []; schedulesCache = {}; attendanceCache = {};
                setButtonLoadingState(logoutBtnEl, false);
            }, 300);
        });
        
        toggleThemeBtnEl.addEventListener('click', () => {
            const isDark = htmlEl.toggleAttribute('data-theme'); 
            localStorage.setItem('piketOSIS_darkMode_MD3', isDark);
            updateThemeIcon(isDark);
        });

        function updateThemeIcon(isDark) {
            const moonIcon = toggleThemeBtnEl.querySelector('.fa-moon');
            const sunIcon = toggleThemeBtnEl.querySelector('.fa-sun');
            if (isDark) {
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            } else {
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            }
        }
        
        const savedThemeIsDark = localStorage.getItem('piketOSIS_darkMode_MD3') === 'true';
        if (savedThemeIsDark) htmlEl.setAttribute('data-theme', 'dark');
        updateThemeIcon(savedThemeIsDark);


        // --- UTILITIES ---
        function showToast(message, type = 'info') {
            let background, textColor;
            switch (type) {
                case 'success': background = 'var(--md-sys-color-primary-container)'; textColor = 'var(--md-sys-color-on-primary-container)'; break;
                case 'error': background = 'var(--md-sys-color-error-container)'; textColor = 'var(--md-sys-color-on-error-container)'; break;
                case 'warning': background = 'var(--md-sys-color-tertiary-container)'; textColor = 'var(--md-sys-color-on-tertiary-container)'; break;
                default: background = 'var(--md-sys-color-inverse-surface)'; textColor = 'var(--md-sys-color-inverse-on-surface)';
            }
            Toastify({ text: message, duration: 3000, close: true, gravity: "bottom", position: "right", style: { background, color: textColor, borderRadius: "var(--md-sys-shape-corner-small)", boxShadow: "var(--md-sys-elevation-level-2)", padding: "1rem" }}).showToast();
        }
        function getDayNameFromDate(dateString) { const date = new Date(dateString + "T00:00:00"); return daysOfWeek[date.getDay()];}
        
        function setButtonLoadingState(button, isLoading, loadingText = "Memproses...") {
            const textEl = button.querySelector('.button-text');
            const iconEl = button.querySelector('.button-icon'); 
            const spinnerEl = button.querySelector('.button-spinner'); 
            const defaultText = button.dataset.defaultText || "Aksi";

            if (isLoading) {
                button.disabled = true;
                if (textEl) textEl.textContent = loadingText;
                if (iconEl) iconEl.style.display = 'none';
                if (spinnerEl) spinnerEl.style.display = 'inline-block'; 
            } else {
                button.disabled = false;
                if (textEl) textEl.textContent = defaultText;
                if (iconEl) iconEl.style.display = 'inline-block';
                if (spinnerEl) spinnerEl.style.display = 'none';
            }
        }
        
        // --- MAIN APP ---
        async function initializeApp() {
            setupTabs(); await loadInitialData(); setupMemberManagement();
            setupScheduleManagement(); setupAttendanceManagement(); setupReportManagement();
            setupDataManagement(); document.querySelector('[data-tab="members"]').click();
            setDefaultAttendanceDate(); populateYearDropdownReport();
        }
        async function loadInitialData() { 
            showToast('Memuat data awal...', 'info');
            try {
                const membersSnapshot = await db.collection('members').orderBy('name').get();
                membersCache = membersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const schedulesSnapshot = await db.collection('schedules').get();
                schedulesCache = {};
                schedulesSnapshot.forEach(doc => {
                    schedulesCache[doc.id] = doc.data().memberIds || [];
                });
                showToast('Data awal berhasil dimuat.', 'success');
            } catch (error) {
                console.error("Error loading initial data:", error);
                showToast('Gagal memuat data awal.', 'error');
            }
         }
        function setupTabs() { 
            const tabsContainer = document.getElementById('tabs');
            const tabButtons = tabsContainer.querySelectorAll('.md-tabs__button');
            const tabContents = document.querySelectorAll('.md-tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.add('hidden'));
                    
                    button.classList.add('active');
                    const tabId = button.dataset.tab;
                    document.getElementById(`${tabId}-tab`).classList.remove('hidden');
                    
                    if (tabId === 'members') renderMembersTable();
                    else if (tabId === 'schedule') {
                        renderScheduleEditor(document.getElementById('schedule-day-select').value);
                        renderFullWeekSchedule();
                    }
                });
            });
         }
        
        // --- MEMBER MANAGEMENT ---
        const membersListEl = document.getElementById('members-list');
        const searchMemberInput = document.getElementById('search-member');
        const addMemberBtnEl = document.getElementById('add-member-btn');
        const memberModalEl = document.getElementById('member-modal');
        const memberModalTitleEl = document.getElementById('member-modal-title');
        const memberIdInputEl = document.getElementById('member-id-input');
        const memberNameInputEl = document.getElementById('member-name-input');
        const memberNameErrorEl = document.getElementById('member-name-error');
        const saveMemberBtnEl = document.getElementById('save-member-btn');
        const cancelMemberBtnEl = document.getElementById('cancel-member-btn');
        function setupMemberManagement() { 
            searchMemberInput.addEventListener('input', renderMembersTable);
            addMemberBtnEl.addEventListener('click', openAddMemberModal);
            saveMemberBtnEl.addEventListener('click', handleSaveMember);
            cancelMemberBtnEl.addEventListener('click', () => {
                memberModalEl.classList.add('hidden');
                memberModalEl.classList.remove('visible');
            });
         }
        function renderMembersTable() { 
            const loadingRow = document.getElementById('members-loading-row');
            if (loadingRow) loadingRow.classList.add('hidden'); 
            
            const searchTerm = searchMemberInput.value.toLowerCase();
            const filteredMembers = membersCache.filter(member => 
                member.name.toLowerCase().includes(searchTerm)
            );

            if (membersCache.length === 0 && !searchTerm) {
                membersListEl.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:1rem; color: var(--md-sys-color-on-surface-variant);">Belum ada anggota.</td></tr>`;
                return;
            }
            if (filteredMembers.length === 0) {
                membersListEl.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:1rem; color: var(--md-sys-color-on-surface-variant);">Tidak ada anggota cocok "${searchTerm}".</td></tr>`;
                return;
            }
            
            membersListEl.innerHTML = filteredMembers.map((member, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${member.name}</td>
                    <td class="table-actions">
                        <button class="md-icon-button edit-member-btn" data-id="${member.id}" title="Edit" style="color: var(--md-sys-color-primary);">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="md-icon-button delete-member-btn" data-id="${member.id}" title="Hapus" style="color: var(--md-sys-color-error);">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            document.querySelectorAll('.edit-member-btn').forEach(btn => btn.addEventListener('click', (e) => openEditMemberModal(e.currentTarget.dataset.id)));
            document.querySelectorAll('.delete-member-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteMember(e.currentTarget.dataset.id)));
         }
        function openAddMemberModal() { 
            memberModalTitleEl.textContent = 'Tambah Anggota Baru';
            memberIdInputEl.value = '';
            memberNameInputEl.value = '';
            memberNameErrorEl.classList.add('hidden');
            memberNameInputEl.parentElement.classList.remove('error'); 
            memberModalEl.classList.remove('hidden');
            memberModalEl.classList.add('visible');
            memberNameInputEl.focus();
         }
        function openEditMemberModal(memberId) { 
            const member = membersCache.find(m => m.id === memberId);
            if (!member) return;
            memberModalTitleEl.textContent = 'Edit Anggota';
            memberIdInputEl.value = member.id;
            memberNameInputEl.value = member.name;
            memberNameErrorEl.classList.add('hidden');
            memberNameInputEl.parentElement.classList.remove('error');
            memberModalEl.classList.remove('hidden');
            memberModalEl.classList.add('visible');
            memberNameInputEl.focus();
         }
        async function handleSaveMember() { 
            const name = memberNameInputEl.value.trim();
            const id = memberIdInputEl.value;
            const nameContainer = memberNameInputEl.parentElement;

            if (!name) {
                nameContainer.classList.add('error');
                memberNameErrorEl.classList.remove('hidden');
                return;
            }
            nameContainer.classList.remove('error');
            memberNameErrorEl.classList.add('hidden');

            setButtonLoadingState(saveMemberBtnEl, true, "Menyimpan...");
            try {
                if (id) { 
                    await db.collection('members').doc(id).update({ name });
                    const memberIndex = membersCache.findIndex(m => m.id === id);
                    if (memberIndex > -1) membersCache[memberIndex].name = name;
                    showToast('Anggota berhasil diperbarui', 'success');
                } else { 
                    const docRef = await db.collection('members').add({ name });
                    membersCache.push({ id: docRef.id, name });
                    membersCache.sort((a,b) => a.name.localeCompare(b.name));
                    showToast('Anggota berhasil ditambahkan', 'success');
                }
                memberModalEl.classList.add('hidden');
                memberModalEl.classList.remove('visible');
                renderMembersTable();
                if (document.getElementById('schedule-tab').classList.contains('active')) {
                    renderScheduleEditor(document.getElementById('schedule-day-select').value);
                }
            } catch (error) {
                console.error("Error saving member:", error);
                showToast(`Gagal menyimpan anggota: ${error.message}`, 'error');
            } finally {
                setButtonLoadingState(saveMemberBtnEl, false);
            }
         }
         async function handleDeleteMember(memberId) { 
            const member = membersCache.find(m => m.id === memberId);
            if (!member) return;

            if (!confirm(`Anda yakin ingin menghapus anggota "${member.name}"? Anggota ini juga akan dihapus dari semua jadwal dan catatan kehadiran.`)) {
                return;
            }
            showToast(`Menghapus ${member.name}...`, 'info');
            try {
                const batch = db.batch();
                batch.delete(db.collection('members').doc(memberId));

                for (const day in schedulesCache) {
                    if (schedulesCache[day].includes(memberId)) {
                        const updatedDaySchedule = schedulesCache[day].filter(id => id !== memberId);
                        batch.update(db.collection('schedules').doc(day), { memberIds: updatedDaySchedule });
                        schedulesCache[day] = updatedDaySchedule; 
                    }
                }
                await batch.commit();
                membersCache = membersCache.filter(m => m.id !== memberId);
                showToast(`Anggota "${member.name}" berhasil dihapus.`, 'success');
                renderMembersTable();
                 if (document.getElementById('schedule-tab').classList.contains('active')) {
                    renderScheduleEditor(document.getElementById('schedule-day-select').value);
                    renderFullWeekSchedule();
                }
                if (document.getElementById('attendance-tab').classList.contains('active') && document.getElementById('attendance-date').value) {
                    loadAttendanceForDate(); 
                }
            } catch (error) {
                console.error("Error deleting member:", error);
                showToast(`Gagal menghapus anggota: ${error.message}`, 'error');
            }
          }

        // --- SCHEDULE MANAGEMENT ---
        const scheduleDaySelectEl = document.getElementById('schedule-day-select');
        const clearDayScheduleBtnEl = document.getElementById('clear-day-schedule');
        const availableMembersScheduleEl = document.getElementById('available-members-schedule');
        const scheduledMembersListEl = document.getElementById('scheduled-members-list');
        const selectedDayNameScheduleEl = document.getElementById('selected-day-name-schedule');
        const fullWeekScheduleDisplayEl = document.getElementById('full-week-schedule-display');

        function setupScheduleManagement() { 
            scheduleDaySelectEl.addEventListener('change', (e) => {
                renderScheduleEditor(e.target.value);
                selectedDayNameScheduleEl.textContent = e.target.value;
            });
            clearDayScheduleBtnEl.addEventListener('click', handleClearDaySchedule);
         }
        function renderScheduleEditor(day) { 
            selectedDayNameScheduleEl.textContent = day;
            const currentDayScheduledIds = schedulesCache[day] || [];
            const availableForScheduling = membersCache.filter(member => !currentDayScheduledIds.includes(member.id));
            
            if (availableForScheduling.length === 0) {
                availableMembersScheduleEl.innerHTML = `<p style="color: var(--md-sys-color-on-surface-variant); padding: 0.5rem;">Semua anggota sudah dijadwalkan atau tidak ada.</p>`;
            } else {
                availableMembersScheduleEl.innerHTML = availableForScheduling.map(member => `
                    <div class="md-list-item">
                        <span class="md-list-item__text">${member.name}</span>
                        <button class="md-button md-button--text assign-member-schedule-btn" data-member-id="${member.id}" data-day="${day}" title="Tambahkan" data-default-text="Tambah">
                             <span class="button-icon-spinner-container">
                                <i class="fas fa-plus button-icon"></i>
                                <i class="fas fa-spinner fa-spin button-spinner hidden"></i>
                            </span>
                            <span class="button-text">Tambah</span>
                        </button>
                    </div>
                `).join('');
            }

            const scheduledOnThisDay = currentDayScheduledIds
                .map(id => membersCache.find(m => m.id === id)).filter(Boolean);

            if (scheduledOnThisDay.length === 0) {
                scheduledMembersListEl.innerHTML = `<p style="color: var(--md-sys-color-on-surface-variant); padding: 0.5rem;">Belum ada jadwal untuk ${day}.</p>`;
            } else {
                scheduledMembersListEl.innerHTML = scheduledOnThisDay.map(member => `
                    <div class="md-list-item">
                        <span class="md-list-item__text">${member.name}</span>
                        <button class="md-button md-button--text danger remove-member-schedule-btn" data-member-id="${member.id}" data-day="${day}" title="Hapus" data-default-text="Hapus">
                            <span class="button-icon-spinner-container">
                                <i class="fas fa-times button-icon"></i>
                                <i class="fas fa-spinner fa-spin button-spinner hidden"></i>
                            </span>
                            <span class="button-text">Hapus</span>
                        </button>
                    </div>
                `).join('');
            }
            document.querySelectorAll('.assign-member-schedule-btn').forEach(btn => btn.addEventListener('click', handleAssignMemberToSchedule));
            document.querySelectorAll('.remove-member-schedule-btn').forEach(btn => btn.addEventListener('click', handleRemoveMemberFromSchedule));
         }
        async function handleAssignMemberToSchedule(event) { 
            const { memberId, day } = event.currentTarget.dataset;
            const currentDayScheduledIds = schedulesCache[day] || [];
            if (!currentDayScheduledIds.includes(memberId)) {
                const newScheduledIds = [...currentDayScheduledIds, memberId];
                setButtonLoadingState(event.currentTarget, true, "Menambah...");
                try {
                    await db.collection('schedules').doc(day).set({ memberIds: newScheduledIds });
                    schedulesCache[day] = newScheduledIds;
                    showToast('Anggota ditambahkan ke jadwal', 'success');
                    renderScheduleEditor(day);
                    renderFullWeekSchedule();
                } catch (error) { console.error("Error assigning member:", error); showToast('Gagal menambahkan.', 'error'); 
                } finally { setButtonLoadingState(event.currentTarget, false); }
            }
         }
        async function handleRemoveMemberFromSchedule(event) { 
            const { memberId, day } = event.currentTarget.dataset;
            const currentDayScheduledIds = schedulesCache[day] || [];
            if (currentDayScheduledIds.includes(memberId)) {
                const newScheduledIds = currentDayScheduledIds.filter(id => id !== memberId);
                setButtonLoadingState(event.currentTarget, true, "Menghapus...");
                 try {
                    await db.collection('schedules').doc(day).set({ memberIds: newScheduledIds });
                    schedulesCache[day] = newScheduledIds;
                    showToast('Anggota dihapus dari jadwal', 'success');
                    renderScheduleEditor(day);
                    renderFullWeekSchedule();
                } catch (error) { console.error("Error removing member:", error); showToast('Gagal menghapus.', 'error');
                } finally { setButtonLoadingState(event.currentTarget, false); }
            }
         }
        async function handleClearDaySchedule() { 
            const day = scheduleDaySelectEl.value;
            if (!confirm(`Yakin hapus jadwal ${day}?`)) return;
            setButtonLoadingState(clearDayScheduleBtnEl, true);
            try {
                await db.collection('schedules').doc(day).set({ memberIds: [] });
                schedulesCache[day] = [];
                showToast(`Jadwal ${day} dikosongkan.`, 'success');
                renderScheduleEditor(day);
                renderFullWeekSchedule();
            } catch (error) { console.error("Error clearing schedule:", error); showToast(`Gagal kosongkan jadwal.`, 'error');
            } finally { setButtonLoadingState(clearDayScheduleBtnEl, false); }
         }
        function renderFullWeekSchedule() { 
            fullWeekScheduleDisplayEl.innerHTML = '';
            let hasAnySchedule = false;
            daysOfWeek.forEach(day => {
                const memberIdsOnDay = schedulesCache[day] || [];
                if (memberIdsOnDay.length > 0) hasAnySchedule = true;
                const membersOnDay = memberIdsOnDay.map(id => membersCache.find(m => m.id === id))
                    .filter(Boolean).map(m => m.name).join(', ');
                const dayDiv = document.createElement('div');
                dayDiv.className = 'md-list-item'; 
                dayDiv.innerHTML = `
                    <strong style="min-width: 80px; color: var(--md-sys-color-primary);">${day}:</strong> 
                    <span class="md-list-item__text">${membersOnDay || '<em>(Kosong)</em>'}</span>`;
                fullWeekScheduleDisplayEl.appendChild(dayDiv);
            });
             if (!hasAnySchedule) {
                fullWeekScheduleDisplayEl.innerHTML = `<p style="text-align:center; padding:1rem; color: var(--md-sys-color-on-surface-variant);">Belum ada jadwal minggu ini.</p>`;
            }
         }

        // --- ATTENDANCE MANAGEMENT ---
        const attendanceDateInputEl = document.getElementById('attendance-date');
        const loadAttendanceBtnEl = document.getElementById('load-attendance');
        const noScheduleAttendanceEl = document.getElementById('no-schedule-attendance');
        const attendanceFormContainerEl = document.getElementById('attendance-form-container');
        const attendanceDateDisplayEl = document.getElementById('attendance-date-display');
        const attendanceDayDisplayEl = document.getElementById('attendance-day-display');
        const attendanceListEl = document.getElementById('attendance-list');
        const saveAttendanceBtnEl = document.getElementById('save-attendance');
        const attendanceStatusSummaryEl = document.getElementById('attendance-status-summary');
        const swapDutyModalEl = document.getElementById('swap-duty-modal');
        const swapModalOriginalMemberNameEl = document.getElementById('swap-modal-original-member-name');
        const swapModalDateDisplayEl = document.getElementById('swap-modal-date-display');
        const swapOriginalMemberIdInputEl = document.getElementById('swap-original-member-id');
        const swapAttendanceDateHiddenInputEl = document.getElementById('swap-attendance-date-hidden');
        const swapMemberSelectEl = document.getElementById('swap-member-select');
        const swapReasonInputEl = document.getElementById('swap-reason-input');
        const confirmSwapBtnEl = document.getElementById('confirm-swap-btn');
        const cancelSwapBtnEl = document.getElementById('cancel-swap-btn');

        function setDefaultAttendanceDate() { 
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            attendanceDateInputEl.value = `${yyyy}-${mm}-${dd}`;
         }
        function setupAttendanceManagement() { 
            loadAttendanceBtnEl.addEventListener('click', loadAttendanceForDate);
            saveAttendanceBtnEl.addEventListener('click', handleSaveAttendance);
            confirmSwapBtnEl.addEventListener('click', handleConfirmSwap);
            cancelSwapBtnEl.addEventListener('click', () => {
                swapDutyModalEl.classList.add('hidden');
                swapDutyModalEl.classList.remove('visible');
            });
         }
       async function loadAttendanceForDate() { 
            const dateStr = attendanceDateInputEl.value;
            if (!dateStr) { showToast('Pilih tanggal.', 'warning'); return; }
            const dayName = getDayNameFromDate(dateStr);
            
            attendanceDateDisplayEl.textContent = dateStr;
            attendanceDayDisplayEl.textContent = dayName;
            attendanceListEl.innerHTML = `<div style="text-align:center; padding:1rem; color: var(--md-sys-color-on-surface-variant);">Memuat...</div>`;
            attendanceFormContainerEl.classList.remove('hidden');
            noScheduleAttendanceEl.classList.add('hidden');
            setButtonLoadingState(loadAttendanceBtnEl, true);

            try {
                const scheduledMemberIds = schedulesCache[dayName] || [];
                if (scheduledMemberIds.length === 0) {
                    noScheduleAttendanceEl.classList.remove('hidden');
                    attendanceFormContainerEl.classList.add('hidden');
                    attendanceStatusSummaryEl.innerHTML = `<p style="color: var(--md-sys-color-on-surface-variant);">Tidak ada jadwal piket untuk ${dayName}, ${dateStr}.</p>`;
                     setButtonLoadingState(loadAttendanceBtnEl, false); 
                    return;
                }

                const attendanceDoc = await db.collection('attendance').doc(dateStr).get();
                const dayAttendanceRecords = attendanceDoc.exists ? attendanceDoc.data().records || {} : {};
                attendanceCache[dateStr] = JSON.parse(JSON.stringify(dayAttendanceRecords)); 

                let membersForAttendance = [];
                scheduledMemberIds.forEach(id => {
                    const member = membersCache.find(m => m.id === id);
                    if (member) { 
                        membersForAttendance.push({
                            ...member,
                            ...(dayAttendanceRecords[id] || { present: false, reason: '', swappedOut: false, substituteId: null, isSubstitute: false, replacedId: null })
                        });
                    }
                });
                Object.keys(dayAttendanceRecords).forEach(memberId => {
                    if (dayAttendanceRecords[memberId].isSubstitute && !membersForAttendance.find(m => m.id === memberId)) {
                        const member = membersCache.find(m => m.id === memberId);
                        if (member) membersForAttendance.push({ ...member, ...dayAttendanceRecords[memberId] });
                    }
                });
                renderAttendanceForm(membersForAttendance, dateStr);
                renderAttendanceStatusSummary(dateStr, dayName, membersForAttendance);
            } catch (error) {
                console.error("Error loading attendance:", error);
                showToast('Gagal memuat absensi.', 'error');
                attendanceListEl.innerHTML = `<div style="text-align:center; padding:1rem; color: var(--md-sys-color-error);">Gagal memuat.</div>`;
            } finally {
                 setButtonLoadingState(loadAttendanceBtnEl, false);
            }
         }
        function renderAttendanceForm(attendanceData, dateStr) { 
            if (attendanceData.length === 0) {
                 attendanceListEl.innerHTML = `<p style="color: var(--md-sys-color-on-surface-variant); padding: 0.5rem;">Tidak ada anggota.`;
                 saveAttendanceBtnEl.classList.add('hidden'); return;
            }
            saveAttendanceBtnEl.classList.remove('hidden');
            setButtonLoadingState(saveAttendanceBtnEl, false); 

            attendanceListEl.innerHTML = attendanceData.map(item => {
                const { id, name, present = false, reason = '', swappedOut = false, substituteId, isSubstitute = false, replacedId } = item;
                let statusInfo = ''; let nameClass = '';
                if (swappedOut) {
                    const subName = membersCache.find(m => m.id === substituteId)?.name || 'N/A';
                    statusInfo = `(Digantikan oleh ${subName})`; nameClass = 'swapped-out';
                } else if (isSubstitute) {
                    const repName = membersCache.find(m => m.id === replacedId)?.name || 'N/A';
                    statusInfo = `(Menggantikan ${repName})`; nameClass = 'substitute';
                }
                return `
                    <div class="attendance-item-md" data-member-id="${id}">
                        <div class="attendance-item-md__header">
                            <span class="attendance-item-md__name ${nameClass}">${name}</span>
                            ${statusInfo ? `<span class="attendance-item-md__status-text">${statusInfo}</span>` : ''}
                        </div>
                        <div class="attendance-item-md__controls">
                            ${!swappedOut && !isSubstitute ? `
                                <label class="md-selection-label">
                                    <input type="radio" name="attendance-${id}" value="present" class="attendance-radio" ${present ? 'checked' : ''}> Hadir
                                </label>
                                <label class="md-selection-label">
                                    <input type="radio" name="attendance-${id}" value="absent" class="attendance-radio" ${!present ? 'checked' : ''}> Absen
                                </label>
                                <div class="md-textfield-container reason-input-container ${present ? 'hidden' : ''}" style="flex-grow:1; margin-bottom:0;">
                                    <label for="reason-${id}" class="md-textfield-label visually-hidden">Alasan</label>
                                    <input type="text" id="reason-${id}" class="md-textfield reason-input" placeholder="Alasan..." value="${reason}">
                                </div>
                                <button class="md-button md-button--outlined swap-duty-btn" data-original-member-id="${id}" data-original-member-name="${name}" data-date="${dateStr}" style="padding: 0.5rem 1rem;">
                                    <i class="fas fa-exchange-alt"></i> Ganti
                                </button>
                            ` : `<span class="attendance-item-md__status-text" style="font-style:italic;">${swappedOut ? 'Tugas dialihkan.' : 'Bertugas sebagai pengganti.'}</span>`}
                        </div>
                    </div>`;
            }).join('');
            document.querySelectorAll('.attendance-radio').forEach(r => r.addEventListener('change', (e) => {
                const parent = e.target.closest('.attendance-item-md__controls');
                parent.querySelector('.reason-input-container')?.classList.toggle('hidden', e.target.value === 'present');
            }));
            document.querySelectorAll('.swap-duty-btn').forEach(btn => btn.addEventListener('click', openSwapDutyModalHandler));
         }
        function renderAttendanceStatusSummary(dateStr, dayName, attendanceData) { 
            let presentCount = 0, absentCount = 0, swappedOutCount = 0, substituteCount = 0;
            const detailedStatus = attendanceData.map(item => {
                const member = membersCache.find(m => m.id === item.id);
                if (!member) return '';
                let status = '';
                if (item.isSubstitute) {
                    const repName = membersCache.find(m => m.id === item.replacedId)?.name || 'N/A';
                    status = `<span style="color: var(--md-sys-color-tertiary);">Hadir (Pengganti ${repName})</span>`;
                    substituteCount++; presentCount++;
                } else if (item.swappedOut) {
                    const subName = membersCache.find(m => m.id === item.substituteId)?.name || 'N/A';
                    status = `<span style="color: var(--md-sys-color-secondary);">Digantikan oleh ${subName}</span>`;
                    swappedOutCount++;
                } else if (item.present) {
                    status = `<span style="color: var(--md-sys-color-primary);">Hadir</span>`; presentCount++;
                } else {
                    status = `<span style="color: var(--md-sys-color-error);">Absen${item.reason ? ` (${item.reason})` : ''}</span>`; absentCount++;
                }
                return `<li><strong>${member.name}:</strong> ${status}</li>`;
            }).join('');
            attendanceStatusSummaryEl.innerHTML = `
                <h4 class="md-card__subtitle" style="margin-bottom:0.5rem;">Ringkasan ${dayName}, ${dateStr}:</h4>
                <p>Hadir: <strong style="color: var(--md-sys-color-primary);">${presentCount}</strong> (termasuk ${substituteCount} pengganti)</p>
                <p>Absen (tdk diganti): <strong style="color: var(--md-sys-color-error);">${absentCount}</strong></p>
                <p>Digantikan: <strong style="color: var(--md-sys-color-secondary);">${swappedOutCount}</strong></p>
                ${detailedStatus ? `<h5 class="md-card__subtitle" style="margin-top:1rem; margin-bottom:0.25rem;">Detail:</h5><ul style="list-style: disc; padding-left: 1.5rem; font-size:0.875rem; color: var(--md-sys-color-on-surface-variant);">${detailedStatus}</ul>` : ''}`;
         }
        async function handleSaveAttendance() {
            const dateStr = attendanceDateInputEl.value;
            if (!dateStr) { showToast('Tanggal tidak valid.', 'error'); return; }
            setButtonLoadingState(saveAttendanceBtnEl, true, "Menyimpan..."); 

            const newRecords = { ...(attendanceCache[dateStr] || {}) }; 
            document.querySelectorAll('.attendance-item-md').forEach(itemDiv => {
                const memberId = itemDiv.dataset.memberId;
                const currentItemRecord = newRecords[memberId] || { 
                    present: false, reason: '', 
                    swappedOut: false, substituteId: null, 
                    isSubstitute: false, replacedId: null 
                };
                
                if (!currentItemRecord.swappedOut && !currentItemRecord.isSubstitute) {
                    const presentRadio = itemDiv.querySelector(`input[name="attendance-${memberId}"][value="present"]`);
                    const isPresentValue = presentRadio ? presentRadio.checked : false; 
                    const reasonInput = itemDiv.querySelector('.reason-input');
                    const reasonValue = (reasonInput && !isPresentValue) ? reasonInput.value.trim() : '';
                    
                    newRecords[memberId] = { 
                        ...currentItemRecord, 
                        present: isPresentValue, 
                        reason: reasonValue,     
                        swappedOut: false, 
                        substituteId: null, 
                        isSubstitute: false, 
                        replacedId: null 
                    };
                }
            });
            try {
                await db.collection('attendance').doc(dateStr).set({ records: newRecords });
                attendanceCache[dateStr] = JSON.parse(JSON.stringify(newRecords)); 
                showToast('Absensi disimpan.', 'success');
                loadAttendanceForDate(); 
            } catch (error) { 
                console.error("Error saving attendance:", error); 
                showToast('Gagal simpan absensi.', 'error');
            } finally { 
                setButtonLoadingState(saveAttendanceBtnEl, false); 
            }
        }
        function openSwapDutyModalHandler(event) { 
            const { originalMemberId, originalMemberName, date } = event.currentTarget.dataset;
            swapModalOriginalMemberNameEl.textContent = originalMemberName;
            swapModalDateDisplayEl.textContent = date;
            swapOriginalMemberIdInputEl.value = originalMemberId;
            swapAttendanceDateHiddenInputEl.value = date;
            swapReasonInputEl.value = '';
            swapMemberSelectEl.innerHTML = '<option value="">-- Pilih Pengganti --</option>';
            membersCache.forEach(member => {
                if (member.id !== originalMemberId) {
                    const option = document.createElement('option');
                    option.value = member.id; option.textContent = member.name;
                    swapMemberSelectEl.appendChild(option);
                }
            });
            swapDutyModalEl.classList.remove('hidden');
            swapDutyModalEl.classList.add('visible');
         }
        async function handleConfirmSwap() { 
            const originalMemberId = swapOriginalMemberIdInputEl.value;
            const dateStr = swapAttendanceDateHiddenInputEl.value;
            const substituteMemberId = swapMemberSelectEl.value;
            const reason = swapReasonInputEl.value.trim();
            if (!substituteMemberId) { showToast('Pilih pengganti.', 'warning'); return; }
            setButtonLoadingState(confirmSwapBtnEl, true);
            try {
                const attendanceRef = db.collection('attendance').doc(dateStr);
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(attendanceRef);
                    const records = doc.exists ? doc.data().records || {} : {};
                    records[originalMemberId] = { ...(records[originalMemberId] || {}), present: false, reason, swappedOut: true, substituteId: substituteMemberId, isSubstitute: false, replacedId: null };
                    records[substituteMemberId] = { ...(records[substituteMemberId] || {}), present: true, reason: '', swappedOut: false, substituteId: null, isSubstitute: true, replacedId: originalMemberId };
                    transaction.set(attendanceRef, { records }, { merge: true });
                });
                showToast('Pertukaran tugas disimpan.', 'success');
                swapDutyModalEl.classList.add('hidden');
                swapDutyModalEl.classList.remove('visible');
                if (attendanceCache[dateStr]) {
                     attendanceCache[dateStr][originalMemberId] = { present: false, reason, swappedOut: true, substituteId: substituteMemberId, isSubstitute: false, replacedId: null };
                    attendanceCache[dateStr][substituteMemberId] = { present: true, reason: '', swappedOut: false, substituteId: null, isSubstitute: true, replacedId: originalMemberId };
                }
                loadAttendanceForDate(); 
            } catch (error) { console.error("Error saving swap:", error); showToast('Gagal simpan pertukaran.', 'error');
            } finally { setButtonLoadingState(confirmSwapBtnEl, false); }
         }

        // --- REPORT MANAGEMENT ---
        const reportMonthSelectEl = document.getElementById('report-month');
        const reportYearSelectEl = document.getElementById('report-year');
        const generateReportBtnEl = document.getElementById('generate-report');
        const exportReportBtnEl = document.getElementById('export-report');
        const monthlyAwardDisplayEl = document.getElementById('monthly-award-display');
        const overallAttendanceChartCanvas = document.getElementById('overall-attendance-chart');
        const participationDetailsTableEl = document.getElementById('participation-details-table');
        const reportMonthYearDisplayEl = document.getElementById('report-month-year-display');

        function setupReportManagement() { 
            generateReportBtnEl.addEventListener('click', generateReportData);
            exportReportBtnEl.addEventListener('click', exportReportToCSV);
            exportReportBtnEl.disabled = true;
         }
        function populateYearDropdownReport() { 
            const currentYear = new Date().getFullYear();
            reportYearSelectEl.innerHTML = '';
            for (let year = currentYear; year >= currentYear - 5; year--) {
                const option = document.createElement('option');
                option.value = year; option.textContent = year;
                reportYearSelectEl.appendChild(option);
            }
            reportYearSelectEl.value = currentYear;
            reportMonthSelectEl.value = new Date().getMonth() + 1;
         }
       async function generateReportData() { 
            const selectedMonth = parseInt(reportMonthSelectEl.value);
            const selectedYear = parseInt(reportYearSelectEl.value);
            const monthName = monthsIndonesian[selectedMonth - 1];
            reportMonthYearDisplayEl.textContent = `${monthName} ${selectedYear}`;
            setButtonLoadingState(generateReportBtnEl, true);
            participationDetailsTableEl.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:1rem;">Memproses...</td></tr>`;
            monthlyAwardDisplayEl.innerHTML = `Memproses...`;
            const startDateStr = `${selectedYear}-${String(selectedMonth).padStart(2, '0')}-01`;
            const endDate = new Date(selectedYear, selectedMonth, 0);
            const endDateStr = `${selectedYear}-${String(selectedMonth).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
            const memberStats = {};
            membersCache.forEach(m => { memberStats[m.id] = { name: m.name, scheduled: 0, attended: 0, absentWithReason: 0, absentWithoutReason: 0, swappedOut: 0, substitutedForOthers: 0, }; });
            try {
                const attendanceQuerySnapshot = await db.collection('attendance')
                    .where(firebase.firestore.FieldPath.documentId(), '>=', startDateStr)
                    .where(firebase.firestore.FieldPath.documentId(), '<=', endDateStr).get();
                const monthlyAttendance = {};
                attendanceQuerySnapshot.forEach(doc => { monthlyAttendance[doc.id] = doc.data().records || {}; });
                for (const dateStr in monthlyAttendance) {
                    const recordsOnDate = monthlyAttendance[dateStr];
                    const dayName = getDayNameFromDate(dateStr);
                    const scheduledIdsOnDay = schedulesCache[dayName] || [];
                    scheduledIdsOnDay.forEach(memberId => { if (memberStats[memberId]) memberStats[memberId].scheduled++; });
                    for (const memberId in recordsOnDate) {
                        if (memberStats[memberId]) {
                            const record = recordsOnDate[memberId];
                            if (record.present) { memberStats[memberId].attended++; if (record.isSubstitute) memberStats[memberId].substitutedForOthers++;
                            } else { if (record.swappedOut) memberStats[memberId].swappedOut++; else if (record.reason) memberStats[memberId].absentWithReason++; else memberStats[memberId].absentWithoutReason++; }
                        }
                    }
                }
                renderReportTable(memberStats);
                renderMonthlyAward(memberStats, monthName, selectedYear);
                renderOverallAttendanceChart(memberStats);
                exportReportBtnEl.disabled = false;
                showToast('Laporan dihasilkan.', 'success');
            } catch (error) {
                console.error("Error generating report:", error); showToast('Gagal generate laporan.', 'error');
                participationDetailsTableEl.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:1rem; color:var(--md-sys-color-error);">Gagal.</td></tr>`;
                monthlyAwardDisplayEl.innerHTML = `<p style="color:var(--md-sys-color-error);">Gagal.</p>`;
            } finally { setButtonLoadingState(generateReportBtnEl, false); }
         }
        function renderReportTable(memberStats) { 
            if (Object.keys(memberStats).length === 0) {
                participationDetailsTableEl.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:1rem;">Tidak ada data.</td></tr>`; return;
            }
            let tableHtml = '';
            for (const memberId in memberStats) {
                const stats = memberStats[memberId];
                const ownScheduledDuties = stats.scheduled - stats.substitutedForOthers + stats.swappedOut;
                const attendedOwnDuties = stats.attended - stats.substitutedForOthers;
                const percentageAttendedOwn = ownScheduledDuties > 0 ? ((attendedOwnDuties / ownScheduledDuties) * 100).toFixed(1) : (stats.attended > 0 ? 'N/A' : '0.0');
                tableHtml += `
                    <tr><td>${stats.name}</td><td>${stats.scheduled}</td><td>${stats.attended}</td><td>${stats.absentWithReason + stats.absentWithoutReason}</td><td>${stats.swappedOut}</td><td>${stats.substitutedForOthers}</td><td>${percentageAttendedOwn}%</td></tr>`;
            }
            participationDetailsTableEl.innerHTML = tableHtml;
         }
        function renderMonthlyAward(memberStats, monthName, year) { 
            let maxAttendance = 0; let winners = [];
            for (const memberId in memberStats) {
                const attendedCount = memberStats[memberId].attended;
                if (attendedCount > maxAttendance) { maxAttendance = attendedCount; winners = [memberStats[memberId].name];
                } else if (attendedCount === maxAttendance && maxAttendance > 0) { winners.push(memberStats[memberId].name); }
            }
            if (winners.length > 0) {
                monthlyAwardDisplayEl.innerHTML = `<p style="font-weight:500; color: var(--md-sys-color-primary);">Penghargaan ${monthName} ${year}:</p><p style="font-size:1.2rem; font-weight:bold;">${winners.join(', ')}</p><p>Kehadiran: ${maxAttendance}x.</p>`;
            } else { monthlyAwardDisplayEl.innerHTML = `<p>Tidak ada data untuk penghargaan ${monthName} ${year}.</p>`; }
         }
        function renderOverallAttendanceChart(memberStats) { 
            let totalAttended = 0, totalAbsentSwapped = 0;
            for (const id in memberStats) { totalAttended += memberStats[id].attended; totalAbsentSwapped += (memberStats[id].absentWithReason + memberStats[id].absentWithoutReason + memberStats[id].swappedOut); }
            if (overallAttendanceChartInstance) overallAttendanceChartInstance.destroy();
            overallAttendanceChartInstance = new Chart(overallAttendanceChartCanvas, {
                type: 'doughnut',
                data: { labels: ['Hadir (Incl. Pengganti)', 'Tidak Hadir/Diganti'], datasets: [{ data: [totalAttended, totalAbsentSwapped], backgroundColor: ['var(--md-sys-color-primary-container)', 'var(--md-sys-color-error-container)'], borderColor: ['var(--md-sys-color-primary)', 'var(--md-sys-color-error)'], borderWidth: 1 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: 'var(--md-sys-color-on-surface)'} } } }
            });
         }
         function exportReportToCSV() { 
            const rows = [["Nama", "Dijadwalkan", "Hadir", "Absen", "Digantikan", "Menggantikan", "% Hadir Pribadi"]];
            participationDetailsTableEl.querySelectorAll('tr').forEach(row => {
                const cols = Array.from(row.querySelectorAll('td')).map(td => `"${td.textContent.replace(/"/g, '""')}"`);
                if(cols.length > 0) rows.push(cols);
            });
            if (rows.length <= 1) { showToast('Tidak ada data laporan.', 'warning'); return; }
            const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `laporan_piket_${reportMonthSelectEl.options[reportMonthSelectEl.selectedIndex].text}_${reportYearSelectEl.value}.csv`);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
            showToast('Laporan CSV diunduh.', 'success');
         }

        // --- DATA MANAGEMENT ---
        const createBackupBtn = document.getElementById('create-backup-btn');
        const backupDataTextarea = document.getElementById('backup-data-textarea');
        const copyBackupBtn = document.getElementById('copy-backup-btn');
        const restoreDataTextarea = document.getElementById('restore-data-textarea');
        const confirmRestoreBtn = document.getElementById('confirm-restore-btn');
        const resetAppConfirmBtn = document.getElementById('reset-app-confirm-btn');
        const resetDataModalEl = document.getElementById('reset-data-modal');
        const confirmResetActionBtn = document.getElementById('confirm-reset-action-btn');
        const cancelResetActionBtn = document.getElementById('cancel-reset-action-btn');

        function setupDataManagement() { 
            createBackupBtn.addEventListener('click', handleCreateBackup);
            copyBackupBtn.addEventListener('click', handleCopyBackup);
            confirmRestoreBtn.addEventListener('click', handleConfirmRestore);
            resetAppConfirmBtn.addEventListener('click', () => {
                resetDataModalEl.classList.remove('hidden');
                resetDataModalEl.classList.add('visible');
            });
            confirmResetActionBtn.addEventListener('click', handleResetApplicationData);
            cancelResetActionBtn.addEventListener('click', () => {
                resetDataModalEl.classList.add('hidden');
                resetDataModalEl.classList.remove('visible');
            });
         }
        async function handleCreateBackup() { 
            setButtonLoadingState(createBackupBtn, true);
            try {
                const backupObject = { members: [], schedules: {}, attendance: {} };
                const membersSnap = await db.collection('members').get();
                membersSnap.forEach(doc => backupObject.members.push({ id: doc.id, ...doc.data() }));
                const schedulesSnap = await db.collection('schedules').get();
                schedulesSnap.forEach(doc => backupObject.schedules[doc.id] = doc.data());
                const attendanceSnap = await db.collection('attendance').get();
                attendanceSnap.forEach(doc => backupObject.attendance[doc.id] = doc.data());
                backupDataTextarea.value = JSON.stringify(backupObject, null, 2);
                copyBackupBtn.classList.remove('hidden');
                showToast('Backup data dibuat.', 'success');
            } catch (error) { console.error("Error backup:", error); showToast('Gagal backup.', 'error');
            } finally { setButtonLoadingState(createBackupBtn, false); }
         }
        function handleCopyBackup() { 
            if (!backupDataTextarea.value) { showToast('Tidak ada data untuk disalin.', 'warning'); return; }
            navigator.clipboard.writeText(backupDataTextarea.value)
                .then(() => showToast('Data disalin.', 'success'))
                .catch(err => showToast('Gagal salin.', 'error'));
         }
        async function handleConfirmRestore() { 
            const jsonData = restoreDataTextarea.value.trim();
            if (!jsonData) { showToast('Tidak ada data restore.', 'warning'); return; }
            if (!confirm("PERHATIAN! Timpa data dengan backup ini?")) return;
            setButtonLoadingState(confirmRestoreBtn, true);
            try {
                const backupObject = JSON.parse(jsonData);
                if (!backupObject.members || !backupObject.schedules || !backupObject.attendance) throw new Error("Format backup tidak valid.");
                const batch = db.batch();
                const collectionsToClear = ['members', 'schedules', 'attendance'];
                for (const collName of collectionsToClear) {
                    const snapshot = await db.collection(collName).get();
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                }
                backupObject.members.forEach(member => {
                    const docRef = member.id ? db.collection('members').doc(member.id) : db.collection('members').doc();
                    batch.set(docRef, { name: member.name });
                });
                for (const day in backupObject.schedules) batch.set(db.collection('schedules').doc(day), backupObject.schedules[day]);
                for (const date in backupObject.attendance) batch.set(db.collection('attendance').doc(date), backupObject.attendance[date]);
                await batch.commit();
                showToast('Data dipulihkan. Muat ulang data.', 'success');
                await loadInitialData();
                renderMembersTable(); renderScheduleEditor(scheduleDaySelectEl.value); renderFullWeekSchedule();
                attendanceFormContainerEl.classList.add('hidden');
                noScheduleAttendanceEl.classList.remove('hidden');
                noScheduleAttendanceEl.textContent = 'Data dipulihkan. Muat jadwal absensi baru.';
                attendanceStatusSummaryEl.innerHTML = ''; restoreDataTextarea.value = '';
            } catch (error) { console.error("Error restore:", error); showToast(`Gagal restore: ${error.message}`, 'error');
            } finally { setButtonLoadingState(confirmRestoreBtn, false); }
         }
        async function handleResetApplicationData() { 
            resetDataModalEl.classList.add('hidden');
            resetDataModalEl.classList.remove('visible');
            if (!confirm("PERINGATAN KERAS! Hapus SEMUA data? Tidak bisa dibatalkan.")) return;
            showToast('Mereset data...', 'warning');
            setButtonLoadingState(confirmResetActionBtn, true);
            try {
                const batch = db.batch();
                const collectionsToReset = ['members', 'schedules', 'attendance'];
                for (const collName of collectionsToReset) {
                    const snapshot = await db.collection(collName).limit(500).get(); 
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                }
                await batch.commit();
                membersCache = []; schedulesCache = {}; attendanceCache = {};
                showToast('Semua data direset.', 'success');
                renderMembersTable(); renderScheduleEditor(scheduleDaySelectEl.value); renderFullWeekSchedule();
                attendanceFormContainerEl.classList.add('hidden');
                noScheduleAttendanceEl.classList.remove('hidden');
                noScheduleAttendanceEl.textContent = 'Data direset. Mulai dari awal.';
                attendanceStatusSummaryEl.innerHTML = ''; backupDataTextarea.value = ''; copyBackupBtn.classList.add('hidden');
            } catch (error) { console.error("Error reset:", error); showToast(`Gagal reset: ${error.message}`, 'error');
            } finally { setButtonLoadingState(confirmResetActionBtn, false); }
         }

    </script>
</body>
</html>
