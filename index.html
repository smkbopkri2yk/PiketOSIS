<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Program Piket OSIS (Penghargaan Bulanan)</title>

    <!-- Font Awesome CDN -->
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
    />

    <!-- Toastify CSS CDN -->
    <link
        rel="stylesheet"
        type="text/css"
        href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />

    <style>
        /* =========== GAYA CSS (Penghargaan & Terminologi Baru) =========== */
        :root {
            --primary-blue: #007bff; --secondary-yellow: #ffc107; --light-bg: #f8f9fa; --white: #ffffff; --dark-text: #333; --blue-text: #0056b3; --border-color: #dee2e6; --danger-red: #dc3545; --warning-orange: #fd7e14; --success-green: #28a745; --info-cyan: #17a2b8; --disabled-bg: #e9ecef; --disabled-text: #6c757d; --modal-overlay: rgba(0, 0, 0, 0.6); --gold-color: #ffd700; /* Warna untuk penghargaan */
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: var(--light-bg); color: var(--dark-text); line-height: 1.6; }
        #main-app { width: 100%; max-width: 900px; margin: 0 auto; background-color: var(--white); padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); border-top: 5px solid var(--primary-blue); display: block; opacity: 1; transform: none; }
        #main-app h1, #main-app h2, #main-app h3 { color: var(--primary-blue); }
        #main-app h1 { border-bottom: 2px solid var(--secondary-yellow); padding-bottom: 10px; margin-bottom: 20px; }
        #main-app h2 { border-bottom: 1px solid var(--secondary-yellow); padding-bottom: 8px; margin-bottom: 15px; margin-top: 30px; }
        #main-app h3 { margin-top: 20px; margin-bottom: 10px; color: var(--blue-text); font-size: 1.1em; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid var(--border-color); border-radius: 5px; background-color: #fdfdff; }
        #main-app label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--blue-text); }
        #main-app input[type="text"], #main-app input[type="date"], #main-app select, #main-app textarea, .modal-content input[type="text"], .modal-content input[type="search"] { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; transition: border-color 0.3s ease; }
        #main-app input:focus, #main-app select:focus, #main-app textarea:focus, .modal-content input:focus { border-color: var(--primary-blue); outline: none; box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25); }
        #main-app textarea { min-height: 80px; }

        /* Buttons (Unchanged) */
        #main-app button, .modal-actions button, .modal-header-actions button { background-color: var(--primary-blue); color: var(--white); border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: background-color 0.3s ease, opacity 0.3s ease; margin-right: 10px; margin-bottom: 10px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; position: relative; overflow: hidden; }
        #main-app button i, .modal-actions button i, .modal-header-actions button i { min-width: 1em; text-align: center; }
        #main-app button:hover, .modal-actions button:hover, .modal-header-actions button:hover { background-color: var(--blue-text); }
        #main-app button.secondary, .modal-actions button.secondary, .modal-header-actions button.secondary { background-color: var(--secondary-yellow); color: var(--dark-text); }
        #main-app button.secondary:hover, .modal-actions button.secondary:hover, .modal-header-actions button.secondary:hover { background-color: #e0a800; }
        #main-app button.danger, .modal-actions button.danger, .modal-header-actions button.danger { background-color: var(--danger-red); }
        #main-app button.danger:hover, .modal-actions button.danger:hover, .modal-header-actions button.danger:hover { background-color: #c82333; }
        #main-app button.warning, .modal-actions button.warning, .modal-header-actions button.warning { background-color: var(--warning-orange); }
        #main-app button.warning:hover, .modal-actions button.warning:hover, .modal-header-actions button.warning:hover { background-color: #e46d0f; }
        #main-app button.info, .modal-actions button.info, .modal-header-actions button.info { background-color: var(--info-cyan); }
        #main-app button.info:hover, .modal-actions button.info:hover, .modal-header-actions button.info:hover { background-color: #138496; }
        #main-app button.success, .modal-actions button.success, .modal-header-actions button.success { background-color: var(--success-green); }
        #main-app button.success:hover, .modal-actions button.success:hover, .modal-header-actions button.success:hover { background-color: #218838; }
        #main-app button.small-btn, .modal-actions button.small-btn, .modal-header-actions button.small-btn { padding: 5px 10px; font-size: 0.9em; gap: 5px; margin-right: 5px; margin-bottom: 0; }
        #main-app button.loading, .modal-actions button.loading, .modal-header-actions button.loading { opacity: 0.7; cursor: not-allowed; }
        #main-app button .button-text, .modal-actions button .button-text, .modal-header-actions button .button-text { transition: opacity 0.2s ease; }
        #main-app button.loading .button-text, .modal-actions button.loading .button-text, .modal-header-actions button.loading .button-text { opacity: 0; }
        #main-app button .spinner, .modal-actions button .spinner, .modal-header-actions button .spinner { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: var(--white); width: 18px; height: 18px; animation: spin 1s linear infinite; }
        #main-app button.loading .spinner, .modal-actions button.loading .spinner, .modal-header-actions button.loading .spinner { display: block; }
        @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
        #main-app button:disabled, .modal-actions button:disabled, .modal-header-actions button:disabled { background-color: var(--disabled-bg); color: var(--disabled-text); cursor: not-allowed; opacity: 0.6; }
        #main-app button:disabled:hover, .modal-actions button:disabled:hover, .modal-header-actions button:disabled:hover { background-color: var(--disabled-bg); }

        /* Search Container (Unchanged) */
        .search-container { margin-bottom: 15px; position: relative; }
        .search-container input[type="search"] { width: 100%; padding: 8px 12px 8px 35px; font-size: 0.95rem; border-radius: 20px; border: 1px solid var(--border-color); }
        .search-container .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--disabled-text); z-index: 1; }

        /* Schedule Display (Unchanged) */
        #scheduleDisplay strong { color: var(--primary-blue); min-width: 80px; display: inline-block; }
        #scheduleDisplay div { background-color: var(--light-bg); padding: 10px 15px; margin-bottom: 8px; border: 1px solid var(--border-color); border-radius: 4px; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s ease; }
        #scheduleDisplay div:hover { background-color: #e9ecef; }

        /* Attendance Specifics (Unchanged) */
        #attendanceMarking { transition: opacity 0.4s ease, max-height 0.4s ease, margin-top 0.4s ease; overflow: hidden; opacity: 0; max-height: 0; margin-top: 0 !important; }
        #attendanceMarking.visible { opacity: 1; max-height: 1000px; margin-top: 20px !important; }
        .date-navigation { display: flex; align-items: center; gap: 5px; margin-bottom: 15px; }
        .date-navigation input[type="date"] { flex-grow: 1; margin-bottom: 0; }
        .date-navigation button { padding: 8px 10px; font-size: 1rem; margin-bottom: 0; line-height: 1; }
        #attendanceCheckboxes .attendance-item { display: flex; align-items: center; margin-bottom: 8px; padding: 8px; border-radius: 4px; transition: background-color 0.2s; }
        #attendanceCheckboxes .attendance-item:hover { background-color: #e9ecef; }
        #attendanceCheckboxes label { display: inline-flex; align-items: center; margin-left: 0; margin-right: 15px; font-weight: normal; color: var(--dark-text); cursor: pointer; flex-grow: 1; }
        #attendanceCheckboxes input[type="checkbox"] { margin-right: 8px; transform: scale(1.2); cursor: pointer; }
        #attendanceCheckboxes input[type="text"].reason-input { margin-left: 10px; padding: 4px 8px; font-size: 0.9em; border: 1px solid var(--border-color); border-radius: 3px; width: auto; flex-basis: 200px; transition: opacity 0.3s ease, max-width 0.3s ease; opacity: 0; max-width: 0; overflow: hidden; }
        #attendanceCheckboxes .attendance-item.show-reason .reason-input { opacity: 1; max-width: 200px; }
        #attendanceStatus { margin-top: 20px; padding: 15px; border: 1px dashed var(--primary-blue); border-radius: 5px; }
        #attendanceStatus ul { margin-top: 10px; list-style: none; padding: 0; }
        #attendanceStatus li { margin-bottom: 5px; padding-left: 15px; }
        #attendanceStatus .present { color: var(--success-green); font-weight: bold; }
        #attendanceStatus .absent { color: var(--danger-red); font-weight: bold; }
        #attendanceStatus .reason-text { font-size: 0.9em; color: #555; margin-left: 5px; font-style: italic; }

        /* Reporting (Summary text changed in JS) */
        .report-item { background-color: var(--light-bg); padding: 10px 15px; margin-bottom: 8px; border: 1px solid var(--border-color); border-radius: 4px; display: block; transition: background-color 0.2s ease; }
        .report-item:hover { background-color: #e9ecef; }
        .report-bar-container { display: flex; align-items: center; margin-top: 5px; }
        .report-bar { height: 20px; background-color: var(--primary-blue); border-radius: 3px; margin-right: 10px; min-width: 10px; transition: width 0.5s ease-out; }
        .report-bar.low { background-color: var(--secondary-yellow); } /* Still useful for visual indication */
        .report-text { font-size: 0.9em; color: #555; }
        .report-summary { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); font-size: 1.05em; }
        .report-summary .positive { color: var(--success-green); }
        .report-summary .needs-improvement { color: var(--warning-orange); }
        small { color: #6c757d; display: block; margin-top: -10px; margin-bottom: 15px; }

        /* Monthly Award Section */
        #awardResultDisplay { margin-top: 15px; padding: 15px; border: 1px solid var(--secondary-yellow); border-radius: 5px; background-color: #fffcf1; min-height: 50px; }
        #awardResultDisplay p { margin: 0; font-size: 1.1em; }
        #awardResultDisplay strong { color: var(--blue-text); }
        #awardResultDisplay .winner { color: var(--primary-blue); font-weight: bold; font-size: 1.2em; }
        #awardResultDisplay .winner i { color: var(--gold-color); margin-right: 5px; }

        /* --- MODAL DIALOG Styling (Unchanged) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-overlay); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .modal-content { background-color: var(--white); padding: 0; border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); max-width: 600px; width: 90%; transform: scale(0.9); transition: transform 0.3s ease; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { padding: 15px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-header h3 { margin: 0; color: var(--primary-blue); font-size: 1.3em; }
        .modal-header-actions { margin-left: auto; }
        .modal-body { padding: 20px 25px; overflow-y: auto; flex-grow: 1; }
        .modal-content p { margin-bottom: 15px; line-height: 1.7; }
        .modal-actions { padding: 15px 25px; text-align: right; flex-shrink: 0; border-top: 1px solid var(--border-color); background-color: #f8f9fa; }
        .modal-actions button { margin-left: 10px; margin-bottom: 0; }
        .modal-content label { margin-bottom: 5px; font-size: 0.95em; }
        .modal-content input[type="text"], .modal-content input[type="search"] { margin-bottom: 10px; }

        /* View Members Modal Specifics (Unchanged) */
        #modal-member-list-display { padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
        #modal-member-list-display li { background-color: var(--white); padding: 8px 12px; margin-bottom: 5px; border: 1px solid var(--border-color); border-radius: 4px; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s ease; }
        #modal-member-list-display li:hover { background-color: #f1f1f1; }
        #modal-member-list-display li span.member-name { flex-grow: 1; margin-right: 10px; }
        #modal-member-list-display li .edit-controls input[type="text"] { width: auto; flex-grow: 1; margin-right: 5px; padding: 6px 8px; font-size: 0.95rem; margin-bottom: 0; }
        #modal-member-list-display .view-controls, #modal-member-list-display .edit-controls { gap: 3px; }
        #modal-member-list-display li.editing .view-controls { opacity: 0; max-height: 0; display: none; }
        #modal-member-list-display li.editing .edit-controls { display: flex; opacity: 1; max-height: 50px; width: 100%; }
        #modal-member-list-display li.editing .member-name { display: none; }
        #modal-member-list-display .edit-controls { background-color: transparent; padding: 0; margin: 0; border: none; }

        /* Schedule Modal Specifics (Unchanged) */
        #modal-schedule-member-list { max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 4px; margin-top: 10px; }
        #modal-schedule-member-list label { display: block; margin-bottom: 5px; font-weight: normal; cursor: pointer; padding: 5px; border-radius: 3px; transition: background-color 0.2s; }
        #modal-schedule-member-list label:hover { background-color: #e9ecef; }
        #modal-schedule-member-list input[type="checkbox"] { margin-right: 8px; }
        #modal-schedule-member-list label.hidden { display: none; }

        /* Utility Classes (Unchanged) */
        .hidden { display: none !important; }
        .visually-hidden { /* ... unchanged ... */ }

        /* Print Styles (Unchanged) */
        @media print { /* ... unchanged ... */ }
    </style>
</head>
<body>

    <!-- MAIN APP -->
    <div id="main-app">
        <div class="container">
            <h1><i class="fa-solid fa-clipboard-list"></i> Program Piket OSIS</h1>

            <!-- 1. Anggota OSIS Section (Unchanged) -->
            <div class="section">
                <h2><i class="fa-solid fa-users"></i> Anggota OSIS</h2>
                <button id="open-view-members-modal-button" class="info">
                    <i class="fa-solid fa-address-book"></i> <span class="button-text">Lihat & Kelola Anggota</span>
                </button>
            </div>

            <!-- 2. Input Jadwal Piket (Unchanged) -->
            <div class="section">
                <h2><i class="fa-solid fa-calendar-days"></i> Jadwal Piket Mingguan</h2>
                <label for="scheduleDay">Pilih Hari:</label>
                <select id="scheduleDay">
                    <option value="Senin">Senin</option> <option value="Selasa">Selasa</option> <option value="Rabu">Rabu</option> <option value="Kamis">Kamis</option> <option value="Jumat">Jumat</option> <option value="Sabtu">Sabtu</option> <option value="Minggu">Minggu</option>
                </select>
                <button id="open-edit-schedule-modal-button" class="info">
                    <i class="fa-solid fa-users-gear"></i> <span class="button-text">Pilih/Ubah Anggota Piket Hari Ini</span>
                </button>
                <button id="clear-schedule-button" class="secondary">
                    <i class="fa-solid fa-eraser"></i> <span class="button-text">Kosongkan Jadwal Hari Ini</span> <span class="spinner"></span>
                </button>
                <h3><i class="fa-solid fa-calendar-check"></i> Jadwal Tersimpan:</h3>
                <div id="scheduleDisplay"></div>
            </div>

            <!-- 3. Input Kehadiran Piket (Unchanged) -->
            <div class="section">
                 <h2><i class="fa-solid fa-user-check"></i> Catat Kehadiran Piket</h2>
                 <div class="date-navigation no-print">
                     <button id="prev-day-button" class="secondary small-btn" aria-label="Hari Sebelumnya"><i class="fa-solid fa-chevron-left"></i></button>
                     <input type="date" id="attendanceDate" aria-label="Tanggal Piket"/>
                     <button id="next-day-button" class="secondary small-btn" aria-label="Hari Berikutnya"><i class="fa-solid fa-chevron-right"></i></button>
                 </div>
                 <button id="show-attendance-form-button">
                     <i class="fa-solid fa-pen-to-square"></i> <span class="button-text">Pilih Tanggal & Tampilkan Form</span> <span class="spinner"></span>
                 </button>
                 <div id="attendanceMarking">
                     <h3>Tandai Kehadiran untuk <span id="selectedDateDisplay"></span> (<span id="selectedDayDisplay"></span>):</h3>
                     <p id="noScheduleMessage" style="display:none; color: orange;">Tidak ada jadwal piket untuk hari ini.</p>
                     <div id="attendanceCheckboxes"></div>
                     <button id="saveAttendanceButton" style="display:none;"><i class="fa-solid fa-save"></i> <span class="button-text">Simpan Kehadiran</span> <span class="spinner"></span></button>
                     <div id="attendanceStatus"></div>
                 </div>
            </div>

             <!-- 4. Penghargaan Bulanan (NEW SECTION) -->
             <div class="section" id="monthlyAwardSection">
                 <h2><i class="fa-solid fa-award"></i> Penghargaan Bulanan</h2>
                 <label for="awardMonthSelect">Pilih Bulan untuk Penghargaan:</label>
                 <select id="awardMonthSelect">
                     <option value="">-- Pilih Bulan --</option>
                     <!-- Opsi bulan akan di-generate oleh JS -->
                 </select>
                 <button id="calculateAwardButton" class="success">
                     <i class="fa-solid fa-calculator"></i>
                     <span class="button-text">Tentukan Penerima Penghargaan</span>
                     <span class="spinner"></span>
                 </button>
                 <div id="awardResultDisplay">
                     <p><i>Pilih bulan dan klik tombol untuk melihat penerima penghargaan.</i></p>
                 </div>
             </div>


            <!-- 5. Laporan Kerajinan (Adjusted Section Number) -->
            <div class="section" id="reportSection">
                <h2><i class="fa-solid fa-chart-line"></i> Laporan Partisipasi</h2> <!-- Title changed -->
                <button id="generate-report-button"><i class="fa-solid fa-file-alt"></i> <span class="button-text">Buat Laporan</span> <span class="spinner"></span></button>
                <button id="export-csv-button" class="info small-btn no-print"><i class="fa-solid fa-file-csv"></i> <span class="button-text">Ekspor CSV</span> <span class="spinner"></span></button>
                <small>Laporan didasarkan pada data kehadiran yang sudah disimpan di Firestore.</small>
                <div id="reportDisplay">
                    <!-- Summary text changed in JS -->
                </div>
            </div>

            <!-- 6. Data Management Section (Adjusted Section Number) -->
            <div class="section no-print">
                <h2><i class="fa-solid fa-database"></i> Manajemen Data</h2>
                <div>
                    <h3><i class="fa-solid fa-copy"></i> Backup Data (dari Memori)</h3>
                    <p>Data sudah disimpan ke Firestore, backup ini hanya menyalin data terakhir dimuat.</p>
                    <textarea id="backupDataArea" rows="5" readonly placeholder="Klik 'Backup Data'..."></textarea>
                    <button id="backup-button" class="info"><i class="fa-solid fa-clone"></i> <span class="button-text">Backup Data</span> <span class="spinner"></span></button>
                </div>
                <div style="margin-top: 20px;">
                    <h3><i class="fa-solid fa-upload"></i> Restore Data Lokal ke Firestore</h3>
                    <p><strong>PERHATIAN:</strong> Ini akan menimpa data di Firestore.</p>
                    <textarea id="restoreDataArea" rows="5" placeholder="Tempel data backup (JSON)..."></textarea>
                    <button id="restore-button" class="warning"><i class="fa-solid fa-cloud-upload-alt"></i> <span class="button-text">Restore Data</span> <span class="spinner"></span></button>
                </div>
                <div style="margin-top: 30px; border-top: 1px dashed var(--danger-red); padding-top: 20px;">
                    <h3><i class="fa-solid fa-triangle-exclamation"></i> Reset Aplikasi</h3>
                    <p><strong>PERHATIAN BESAR:</strong> Ini akan menghapus SEMUA data di Firestore.</p>
                    <button id="reset-button" class="danger"><i class="fa-solid fa-bomb"></i> <span class="button-text">Reset Semua Data Aplikasi</span> <span class="spinner"></span></button>
                </div>
            </div>

        </div> <!-- End .container -->
    </div> <!-- End #main-app -->

    <!-- MODAL DIALOGS (Unchanged Structures) -->
    <div id="view-members-modal" class="modal-overlay no-print"> /* ... (kode modal sama) ... */ <div class="modal-content"><div class="modal-header"><h3><i class="fa-solid fa-address-book"></i> Daftar Anggota OSIS</h3><div class="modal-header-actions"><button id="modal-open-add-member-button" class="success small-btn"><i class="fa-solid fa-user-plus"></i> Tambah Baru</button></div></div><div class="modal-body"><div class="search-container"><i class="fa-solid fa-magnifying-glass search-icon"></i><input type="search" id="modal-member-search" placeholder="Cari anggota..." aria-label="Cari Anggota dalam Modal"></div><ul id="modal-member-list-display"></ul></div><div class="modal-actions"><button id="modal-close-view-members" class="secondary"><i class="fa-solid fa-times"></i> Tutup</button></div></div></div>
    <div id="add-member-modal" class="modal-overlay no-print"> /* ... (kode modal sama) ... */ <div class="modal-content"><div class="modal-header"><h3><i class="fa-solid fa-user-plus"></i> Tambah Anggota Baru</h3></div><div class="modal-body"><label for="modal-new-member-name">Nama Lengkap Anggota:</label><input type="text" id="modal-new-member-name" placeholder="Masukkan nama lengkap..." /></div><div class="modal-actions"><button id="modal-cancel-add-member" class="secondary"><i class="fa-solid fa-times"></i> Batal</button><button id="modal-save-member-button"><i class="fa-solid fa-save"></i> <span class="button-text">Simpan Anggota</span> <span class="spinner"></span></button></div></div></div>
    <div id="edit-schedule-modal" class="modal-overlay no-print"> /* ... (kode modal sama) ... */ <div class="modal-content"><div class="modal-header"><h3 id="modal-schedule-title"><i class="fa-solid fa-users-gear"></i> Pilih Anggota Piket</h3></div><div class="modal-body"><div class="search-container"><i class="fa-solid fa-magnifying-glass search-icon"></i><input type="search" id="modal-schedule-search" placeholder="Cari anggota..." aria-label="Cari Anggota dalam Modal Jadwal"></div><div id="modal-schedule-member-list"></div></div><div class="modal-actions"><button id="modal-cancel-edit-schedule" class="secondary"><i class="fa-solid fa-times"></i> Batal</button><button id="modal-confirm-schedule-button" class="success"><i class="fa-solid fa-check"></i> <span class="button-text">Simpan Jadwal Hari Ini</span> <span class="spinner"></span></button></div></div></div>
    <div id="confirmation-modal" class="modal-overlay no-print"> /* ... (kode modal sama) ... */ <div class="modal-content"><div class="modal-header"><h3 id="modal-title">Konfirmasi</h3></div><div class="modal-body"><p id="modal-message">Apakah Anda yakin?</p></div><div class="modal-actions"><button id="modal-cancel-button" class="secondary"><i class="fa-solid fa-times"></i> Batal</button><button id="modal-confirm-button" class="danger"><i class="fa-solid fa-check"></i> <span class="button-text">Ya, Lanjutkan</span> <span class="spinner"></span></button></div></div></div>

    <!-- Toastify JS CDN -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- Script ES Module (v9) -->
    <script type="module">
        /***********************************************************************
         *     1) IMPORT DARI FIREBASE (Unchanged)                           *
         ***********************************************************************/
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
        import { getFirestore, collection, doc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore.js";

        /***********************************************************************
         *           2) KONFIGURASI FIREBASE (Unchanged)                      *
         ***********************************************************************/
        const firebaseConfig = {
            apiKey: "AIzaSyAsBHJoii6RBGrslUH31ix1AyLheRm6HS4",
            authDomain: "piketosis.firebaseapp.com",
            projectId: "piketosis",
            storageBucket: "piketosis.firebasestorage.app",
            messagingSenderId: "341698253309",
            appId: "1:341698253309:web:a5ea2d83768348a7f9c994",
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        /***********************************************************************
         *     3) VARIABEL GLOBAL DAN DOM REFERENCES (Added Award Refs)        *
         ***********************************************************************/
        const daysInIndonesian = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
        const monthNamesIndonesian = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        let members = [];
        let schedule = {};
        let attendance = {};
        let currentConfirmationCallback = null;

        // DOM References (Main Page - Unchanged)
        const mainApp = document.getElementById('main-app');
        const openViewMembersModalButton = document.getElementById('open-view-members-modal-button');
        const scheduleDaySelect = document.getElementById('scheduleDay');
        const openEditScheduleModalButton = document.getElementById('open-edit-schedule-modal-button');
        const scheduleDisplay = document.getElementById('scheduleDisplay');
        const clearScheduleButton = document.getElementById('clear-schedule-button');
        const attendanceDateInput = document.getElementById('attendanceDate');
        const prevDayButton = document.getElementById('prev-day-button');
        const nextDayButton = document.getElementById('next-day-button');
        const showAttendanceFormButton = document.getElementById('show-attendance-form-button');
        const attendanceMarkingDiv = document.getElementById('attendanceMarking');
        const attendanceCheckboxesDiv = document.getElementById('attendanceCheckboxes');
        const noScheduleMessage = document.getElementById('noScheduleMessage');
        const saveAttendanceButton = document.getElementById('saveAttendanceButton');
        const attendanceStatusDiv = document.getElementById('attendanceStatus');
        const selectedDateDisplay = document.getElementById('selectedDateDisplay');
        const selectedDayDisplay = document.getElementById('selectedDayDisplay');
        const reportDisplay = document.getElementById('reportDisplay');
        const generateReportButton = document.getElementById('generate-report-button');
        const exportCsvButton = document.getElementById('export-csv-button');
        const backupDataArea = document.getElementById('backupDataArea');
        const restoreDataArea = document.getElementById('restoreDataArea');
        const backupButton = document.getElementById('backup-button');
        const restoreButton = document.getElementById('restore-button');
        const resetButton = document.getElementById('reset-button');

        // Award Refs
        const awardMonthSelect = document.getElementById('awardMonthSelect');
        const calculateAwardButton = document.getElementById('calculateAwardButton');
        const awardResultDisplay = document.getElementById('awardResultDisplay');

        // Modal References (Unchanged)
        const viewMembersModal = document.getElementById('view-members-modal');
        const modalOpenAddMemberButton = document.getElementById('modal-open-add-member-button');
        const modalMemberSearchInput = document.getElementById('modal-member-search');
        const modalMemberListDisplay = document.getElementById('modal-member-list-display');
        const modalCloseViewMembersButton = document.getElementById('modal-close-view-members');
        const addMemberModal = document.getElementById('add-member-modal');
        const modalNewMemberNameInput = document.getElementById('modal-new-member-name');
        const modalSaveMemberButton = document.getElementById('modal-save-member-button');
        const modalCancelAddMemberButton = document.getElementById('modal-cancel-add-member');
        const editScheduleModal = document.getElementById('edit-schedule-modal');
        const modalScheduleTitle = document.getElementById('modal-schedule-title');
        const modalScheduleSearchInput = document.getElementById('modal-schedule-search');
        const modalScheduleMemberList = document.getElementById('modal-schedule-member-list');
        const modalConfirmScheduleButton = document.getElementById('modal-confirm-schedule-button');
        const modalCancelEditScheduleButton = document.getElementById('modal-cancel-edit-schedule');
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmButton = document.getElementById('modal-confirm-button');
        const modalCancelButton = document.getElementById('modal-cancel-button');

        /***********************************************************************
         *     4) UTILITY FUNCTIONS (Unchanged)                               *
         ***********************************************************************/
        function showNotification(message, type = "info") { /* ... (unchanged) ... */ console.log(`[${type.toUpperCase()}] ${message}`); let bg; switch(type){ case "success": bg="linear-gradient(to right, #00b09b, #96c93d)"; break; case "error": bg="linear-gradient(to right, #ff5f6d, #ffc371)"; break; case "warning": bg="linear-gradient(to right, #f7b733, #fc4a1a)"; break; default: bg="linear-gradient(to right, #007bff, #0056b3)";} Toastify({text:message,duration:3000,close:true,gravity:"top",position:"right",stopOnFocus:true,style:{background:bg}}).showToast(); }
        function showConfirmationModal(title, message, confirmCallback, confirmButtonClass = 'danger') { /* ... (unchanged) ... */ modalTitle.textContent = title; modalMessage.innerHTML = message; currentConfirmationCallback = confirmCallback; modalConfirmButton.className = 'modal-actions button '; modalConfirmButton.classList.add(confirmButtonClass); setLoading(modalConfirmButton, false); confirmationModal.classList.add('visible'); modalConfirmButton.focus(); }
        function hideConfirmationModal() { /* ... (unchanged) ... */ confirmationModal.classList.remove('visible'); currentConfirmationCallback = null; }
        function setLoading(buttonElement, isLoading) { /* ... (unchanged) ... */ if (!buttonElement) return; const textElement = buttonElement.querySelector('.button-text'); if (isLoading) { buttonElement.classList.add('loading'); buttonElement.disabled = true; if (textElement) textElement.style.opacity = '0'; } else { buttonElement.classList.remove('loading'); buttonElement.disabled = false; if (textElement) textElement.style.opacity = '1'; } }
        function changeDate(days) { /* ... (unchanged) ... */ try { const currentDate = new Date(attendanceDateInput.value + "T00:00:00"); if (isNaN(currentDate.getTime())) { showNotification("Tanggal saat ini tidak valid.", "warning"); return; } currentDate.setDate(currentDate.getDate() + days); attendanceDateInput.value = currentDate.toISOString().split('T')[0]; showAttendanceForm(); } catch (e) { showNotification("Gagal mengubah tanggal.", "error"); } }
        function openModal(modalElement) { /* ... (unchanged focus logic) ... */ modalElement.classList.add('visible'); let focusTarget = null; if (modalElement.id === 'add-member-modal') { focusTarget = modalNewMemberNameInput; } else if (modalElement.id === 'view-members-modal') { focusTarget = modalMemberSearchInput; } else if (modalElement.id === 'edit-schedule-modal') { focusTarget = modalScheduleSearchInput; } else if (modalElement.id === 'confirmation-modal') { focusTarget = modalConfirmButton; } if (focusTarget) { setTimeout(() => focusTarget.focus(), 150); } }
        function closeModal(modalElement) { /* ... (unchanged) ... */ modalElement.classList.remove('visible'); }
        function openAddMemberModal() { /* ... (unchanged) ... */ modalNewMemberNameInput.value = ''; setLoading(modalSaveMemberButton, false); openModal(addMemberModal); }
        function openScheduleModal() { /* ... (unchanged) ... */ const selectedDay = scheduleDaySelect.value; modalScheduleTitle.innerHTML = `<i class="fa-solid fa-users-gear"></i> Pilih Anggota Piket - <strong>${selectedDay}</strong>`; modalScheduleSearchInput.value = ''; populateScheduleModal(selectedDay, ''); setLoading(modalConfirmScheduleButton, false); openModal(editScheduleModal); }
        function openViewMembersModal() { /* ... (unchanged) ... */ modalMemberSearchInput.value = ''; displayMembers(''); openModal(viewMembersModal); }


        /***********************************************************************
         *     5) INITIALIZE MAIN APP (Added populateAwardMonthSelect)         *
         ***********************************************************************/
        async function initializeAppMainApp() {
            console.log("Loading data from Firestore...");
            showNotification("Memuat data awal...", "info");
            try {
                await loadAllData();
                displayMembers(); // Populates hidden modal list initially
                displaySchedule();
                setDefaultAttendanceDate();
                populateAwardMonthSelect(); // Populate month dropdown
                addGlobalEventListeners();
                console.log("Main app ready.");
                showNotification("Aplikasi siap digunakan.", "success");
            } catch (err) {
                console.error("Error loading initial data:", err);
                showNotification("Gagal memuat data awal dari Firestore.", "error");
                mainApp.innerHTML = `<div class="section" style="border-color: var(--danger-red);"><h2 style="color: var(--danger-red);"><i class="fa-solid fa-triangle-exclamation"></i> Gagal Memuat Data</h2><p>Tidak dapat terhubung atau memuat data dari database. Silakan coba muat ulang halaman atau periksa konfigurasi Firebase.</p><p><small>${err.message}</small></p></div>`;
            }
        }
        function loadAllData() { /* ... (unchanged) ... */ return Promise.all([ loadMembersFromFirestore(), loadScheduleFromFirestore(), loadAttendanceFromFirestore() ]); }
        async function loadMembersFromFirestore() { /* ... (unchanged) ... */ members = []; const snap = await getDocs(collection(db, "members")); snap.forEach(docSnap => { const data = docSnap.data(); if (data.name) members.push(data.name); }); members.sort((a, b) => a.localeCompare(b)); }
        async function loadScheduleFromFirestore() { /* ... (unchanged) ... */ schedule = {}; const snap = await getDocs(collection(db, "schedules")); snap.forEach(docSnap => { const data = docSnap.data(); if (data.day && Array.isArray(data.members)) { schedule[data.day] = data.members; } }); }
        async function loadAttendanceFromFirestore() { /* ... (unchanged) ... */ attendance = {}; const snap = await getDocs(collection(db, "attendance")); snap.forEach(docSnap => { const data = docSnap.data(); if (data.date && data.records) { attendance[data.date] = migrateAttendanceObject(data.records); } }); }
        function migrateAttendanceObject(records) { /* ... (unchanged) ... */ const result = {}; for (const memberName in records) { const val = records[memberName]; if (typeof val === "boolean") { result[memberName] = { present: val, reason: "" }; } else if (val && typeof val.present === "boolean") { result[memberName] = { present: val.present, reason: val.reason || "" }; } else { console.warn(`Invalid attendance format for ${memberName}:`, val); result[memberName] = { present: false, reason: "" }; } } return result; }
        function setDefaultAttendanceDate() { /* ... (unchanged) ... */ try { attendanceDateInput.valueAsDate = new Date(); } catch (e) { const today = new Date(); const yyyy = today.getFullYear(); const mm = String(today.getMonth() + 1).padStart(2, "0"); const dd = String(today.getDate()).padStart(2, "0"); attendanceDateInput.value = `${yyyy}-${mm}-${dd}`; } }

        function addGlobalEventListeners() {
            // Member Management (Unchanged)
            openViewMembersModalButton.addEventListener('click', openViewMembersModal);
            viewMembersModal.addEventListener('click', (e) => { if (e.target === viewMembersModal) closeModal(viewMembersModal); });
            modalCloseViewMembersButton.addEventListener('click', () => closeModal(viewMembersModal));
            modalMemberSearchInput.addEventListener('input', () => displayMembers(modalMemberSearchInput.value));
            modalOpenAddMemberButton.addEventListener('click', openAddMemberModal);
            modalSaveMemberButton.addEventListener('click', addMember);
            modalCancelAddMemberButton.addEventListener('click', () => closeModal(addMemberModal));
            addMemberModal.addEventListener('click', (e) => { if (e.target === addMemberModal) closeModal(addMemberModal); });

            // Schedule Management (Unchanged)
            openEditScheduleModalButton.addEventListener('click', openScheduleModal);
            scheduleDaySelect.addEventListener('change', displaySchedule);
            modalScheduleSearchInput.addEventListener('input', () => { const selectedDay = scheduleDaySelect.value; populateScheduleModal(selectedDay, modalScheduleSearchInput.value); });
            modalConfirmScheduleButton.addEventListener('click', saveScheduleForDay);
            modalCancelEditScheduleButton.addEventListener('click', () => closeModal(editScheduleModal));
            editScheduleModal.addEventListener('click', (e) => { if (e.target === editScheduleModal) closeModal(editScheduleModal); });
            clearScheduleButton.addEventListener('click', () => { const day = scheduleDaySelect.value; showConfirmationModal('Konfirmasi Kosongkan Jadwal', `Anda yakin ingin mengosongkan jadwal piket untuk hari <strong>${day}</strong>?`, () => clearScheduleForDayAction(day), 'warning'); });

            // Attendance Management (Unchanged)
            showAttendanceFormButton.addEventListener('click', showAttendanceForm);
            prevDayButton.addEventListener('click', () => changeDate(-1));
            nextDayButton.addEventListener('click', () => changeDate(1));
            attendanceCheckboxesDiv.addEventListener('change', handleAttendanceCheckboxChange);
            if (saveAttendanceButton) saveAttendanceButton.addEventListener('click', saveAttendance);

            // Award Calculation
            calculateAwardButton.addEventListener('click', calculateMonthlyAward);

            // Reporting (Unchanged listeners)
            generateReportButton.addEventListener('click', generateReport);
            exportCsvButton.addEventListener('click', exportReportToCSV);

            // Data Management (Unchanged)
            backupButton.addEventListener('click', backupData);
            restoreButton.addEventListener('click', () => { showConfirmationModal('Konfirmasi Restore Data', `<strong>PERHATIAN!</strong> Ini akan <strong>MENIMPA</strong> semua data di Firestore.<br>Pastikan data backup valid. Lanjutkan?`, restoreData, 'warning'); });
            resetButton.addEventListener('click', () => { showConfirmationModal('Konfirmasi Reset Aplikasi', `<strong>PERINGATAN KERAS!</strong> Anda akan <strong>MENGHAPUS SEMUA</strong> data di Firestore.<br>Tindakan ini tidak dapat dibatalkan. Yakin?`, () => resetAllData(false), 'danger'); });

            // Generic Confirmation Modal (Unchanged)
            modalCancelButton.addEventListener('click', hideConfirmationModal);
            modalConfirmButton.addEventListener('click', () => { if (currentConfirmationCallback) { setLoading(modalConfirmButton, true); Promise.resolve(currentConfirmationCallback()).finally(() => { setLoading(modalConfirmButton, false); hideConfirmationModal(); }); } else { hideConfirmationModal(); } });
            confirmationModal.addEventListener('click', (e) => { if (e.target === confirmationModal) { hideConfirmationModal(); } });
        }

        /***********************************************************************
         *     6) MANAGEMENT ANGGOTA (Unchanged)                              *
         ***********************************************************************/
        async function addMember() { /* ... (unchanged) ... */ const name = modalNewMemberNameInput.value.trim(); if (!name) { showNotification("Nama anggota tidak boleh kosong", "warning"); return; } if (members.some(m => m.toLowerCase() === name.toLowerCase())) { showNotification(`Nama "${name}" sudah ada`, "warning"); return; } setLoading(modalSaveMemberButton, true); try { await addDoc(collection(db, "members"), { name }); showNotification(`Anggota "${name}" berhasil ditambahkan.`, "success"); closeModal(addMemberModal); await loadMembersFromFirestore(); displayMembers(modalMemberSearchInput.value); } catch (err) { console.error("Error adding member:", err); showNotification("Gagal menambahkan anggota ke Firestore", "error"); } finally { setLoading(modalSaveMemberButton, false); } }
        function displayMembers(filter = '') { /* ... (unchanged - targets modal list) ... */ modalMemberListDisplay.innerHTML = ""; const lowerCaseFilter = filter.toLowerCase(); const filteredMembers = members.filter(member => member.toLowerCase().includes(lowerCaseFilter)); if (filteredMembers.length === 0) { modalMemberListDisplay.innerHTML = filter ? `<li style="font-style: italic; background: transparent; border: none;">Tidak ada anggota cocok dengan "${filter}".</li>` : "<li style='font-style: italic; background: transparent; border: none;'>Belum ada anggota.</li>"; return; } filteredMembers.forEach(member => { const li = document.createElement("li"); li.dataset.memberName = member; const mainContent = document.createElement('div'); mainContent.style.display = 'flex'; mainContent.style.alignItems = 'center'; mainContent.style.flexGrow = '1'; const nameSpan = document.createElement("span"); nameSpan.textContent = member; nameSpan.classList.add("member-name"); nameSpan.style.marginRight = 'auto'; const viewControls = document.createElement("div"); viewControls.classList.add("view-controls"); const editBtn = document.createElement("button"); editBtn.innerHTML = `<i class="fa-solid fa-pencil"></i><span class="visually-hidden">Edit</span>`; editBtn.classList.add("info", "small-btn"); editBtn.setAttribute('aria-label', `Edit ${member}`); editBtn.onclick = (e) => { e.stopPropagation(); startEditMember(member, li); }; const removeBtn = document.createElement("button"); removeBtn.innerHTML = `<i class="fa-solid fa-trash-can"></i><span class="visually-hidden">Hapus</span>`; removeBtn.classList.add("danger", "small-btn"); removeBtn.setAttribute('aria-label', `Hapus ${member}`); removeBtn.onclick = (e) => { e.stopPropagation(); removeMember(member); }; viewControls.appendChild(editBtn); viewControls.appendChild(removeBtn); mainContent.appendChild(nameSpan); mainContent.appendChild(viewControls); const editControls = document.createElement("div"); editControls.classList.add("edit-controls"); const editInput = document.createElement("input"); editInput.type = "text"; editInput.value = member; editInput.classList.add("edit-member-input"); editInput.onclick = (e) => e.stopPropagation(); const saveBtn = document.createElement("button"); saveBtn.innerHTML = `<i class="fa-solid fa-save"></i> <span class="button-text">Simpan</span> <span class="spinner"></span>`; saveBtn.classList.add("success", "small-btn"); saveBtn.onclick = (e) => { e.stopPropagation(); saveEditMember(member, li); }; const cancelBtn = document.createElement("button"); cancelBtn.innerHTML = `<i class="fa-solid fa-times"></i> <span class="button-text">Batal</span>`; cancelBtn.classList.add("secondary", "small-btn"); cancelBtn.onclick = (e) => { e.stopPropagation(); cancelEditMember(li); }; editControls.appendChild(editInput); editControls.appendChild(saveBtn); editControls.appendChild(cancelBtn); li.appendChild(mainContent); li.appendChild(editControls); modalMemberListDisplay.appendChild(li); }); }
        function startEditMember(memberName, listItemElement) { /* ... (unchanged) ... */ document.querySelectorAll('#modal-member-list-display li.editing').forEach(otherLi => { if (otherLi !== listItemElement) cancelEditMember(otherLi); }); listItemElement.classList.add('editing'); const input = listItemElement.querySelector(".edit-member-input"); input.focus(); input.select(); }
        function cancelEditMember(listItemElement) { /* ... (unchanged) ... */ listItemElement.classList.remove('editing'); const originalName = listItemElement.dataset.memberName; listItemElement.querySelector(".edit-member-input").value = originalName; }
        async function saveEditMember(originalName, listItemElement) { /* ... (unchanged) ... */ const editInput = listItemElement.querySelector(".edit-member-input"); const newName = editInput.value.trim(); const saveButton = listItemElement.querySelector(".edit-controls .success"); if (!newName) { showNotification("Nama tidak boleh kosong", "warning"); return; } if (newName.toLowerCase() !== originalName.toLowerCase() && members.some(m => m.toLowerCase() === newName.toLowerCase())) { showNotification(`Nama "${newName}" sudah digunakan.`, "warning"); return; } if (newName === originalName) { cancelEditMember(listItemElement); return; } setLoading(saveButton, true); try { const memSnap = await getDocs(collection(db, "members")); let docIdToUpdate = null; memSnap.forEach(docSnap => { if (docSnap.data().name === originalName) { docIdToUpdate = docSnap.id; } }); if (!docIdToUpdate) throw new Error(`Anggota "${originalName}" tidak ditemukan.`); const memDocRef = doc(db, "members", docIdToUpdate); await updateDoc(memDocRef, { name: newName }); await renameMemberInRelatedCollections(originalName, newName); showNotification(`Nama "${originalName}" berhasil diubah menjadi "${newName}"`, "success"); await loadAllData(); displayMembers(modalMemberSearchInput.value); displaySchedule(); if (attendanceMarkingDiv.classList.contains('visible')) { showAttendanceForm(); } } catch (err) { console.error("Error saving member edit:", err); showNotification(`Gagal menyimpan perubahan: ${err.message}`, "error"); cancelEditMember(listItemElement); } finally { setLoading(saveButton, false); } }
        async function renameMemberInRelatedCollections(oldName, newName) { /* ... (unchanged) ... */ const batcher = writeBatch(db); let hasChanges = false; const schedSnap = await getDocs(collection(db, "schedules")); schedSnap.forEach(docSnap => { const data = docSnap.data(); if (data.day && Array.isArray(data.members)) { let changed = false; const newArr = data.members.map(m => { if (m === oldName) { changed = true; return newName; } return m; }); if (changed) { batcher.update(doc(db, "schedules", docSnap.id), { members: newArr }); hasChanges = true; } } }); const attSnap = await getDocs(collection(db, "attendance")); attSnap.forEach(docSnap => { const data = docSnap.data(); if (data.records && typeof data.records === 'object' && data.records[oldName]) { const updatedRecords = { ...data.records }; updatedRecords[newName] = updatedRecords[oldName]; delete updatedRecords[oldName]; batcher.update(doc(db, "attendance", docSnap.id), { records: updatedRecords }); hasChanges = true; } }); if (hasChanges) { await batcher.commit(); console.log(`References to "${oldName}" updated to "${newName}".`); } }
        function removeMember(nameToRemove) { /* ... (unchanged) ... */ showConfirmationModal('Konfirmasi Hapus Anggota', `Anda yakin ingin menghapus anggota "<strong>${nameToRemove}</strong>"?<br>Ini juga akan menghapusnya dari semua jadwal dan catatan kehadiran.`, () => removeMemberAction(nameToRemove)); }
        async function removeMemberAction(nameToRemove) { /* ... (unchanged) ... */ showNotification(`Menghapus ${nameToRemove}...`, "info"); try { const memSnap = await getDocs(collection(db, "members")); let docIdToDelete = null; memSnap.forEach(docSnap => { if (docSnap.data().name === nameToRemove) { docIdToDelete = docSnap.id; } }); const batcher = writeBatch(db); if (docIdToDelete) { batcher.delete(doc(db, "members", docIdToDelete)); } const schedSnap = await getDocs(collection(db, "schedules")); schedSnap.forEach(docSnap => { const data = docSnap.data(); if (data.day && Array.isArray(data.members)) { const filtered = data.members.filter(m => m !== nameToRemove); if (filtered.length !== data.members.length) { batcher.update(doc(db, "schedules", docSnap.id), { members: filtered }); } } }); const attSnap = await getDocs(collection(db, "attendance")); attSnap.forEach(docSnap => { const data = docSnap.data(); if (data.records && typeof data.records === 'object' && data.records[nameToRemove]) { const updatedRecords = { ...data.records }; delete updatedRecords[nameToRemove]; batcher.update(doc(db, "attendance", docSnap.id), { records: updatedRecords }); } }); await batcher.commit(); showNotification(`Anggota "${nameToRemove}" berhasil dihapus.`, "success"); await loadAllData(); displayMembers(modalMemberSearchInput.value); displaySchedule(); attendanceMarkingDiv.classList.remove('visible'); attendanceStatusDiv.innerHTML = ""; reportDisplay.innerHTML = ""; } catch (err) { console.error("Error removing member:", err); showNotification("Gagal menghapus anggota di Firestore", "error"); } }

        /***********************************************************************
         *     7) MANAGEMENT JADWAL (Unchanged)                              *
         ***********************************************************************/
        function populateScheduleModal(selectedDay, filter = '') { /* ... (unchanged) ... */ modalScheduleMemberList.innerHTML = ""; const lowerCaseFilter = filter.toLowerCase(); const membersScheduledThisDay = schedule[selectedDay] || []; if (members.length === 0) { modalScheduleMemberList.innerHTML = "<p>Tambahkan anggota.</p>"; return; } let visibleCount = 0; members.forEach(member => { const isVisible = filter === '' || member.toLowerCase().includes(lowerCaseFilter); if (!isVisible) return; visibleCount++; const labelEl = document.createElement("label"); const cb = document.createElement("input"); cb.type = "checkbox"; cb.value = member; const safeMemberId = member.replace(/[^a-zA-Z0-9-_]/g, ""); cb.id = `modal-schedule-cb-${safeMemberId}-${selectedDay}`; cb.checked = membersScheduledThisDay.includes(member); labelEl.appendChild(cb); labelEl.appendChild(document.createTextNode(" " + member)); labelEl.htmlFor = cb.id; modalScheduleMemberList.appendChild(labelEl); }); if (visibleCount === 0 && members.length > 0) { modalScheduleMemberList.innerHTML = `<p>Tidak ada anggota cocok dengan "${filter}".</p>`; } }
        async function saveScheduleForDay() { /* ... (unchanged) ... */ const day = scheduleDaySelect.value; const checkboxes = modalScheduleMemberList.querySelectorAll("input[type='checkbox']:checked"); const selectedMembers = Array.from(checkboxes).map(cb => cb.value); setLoading(modalConfirmScheduleButton, true); try { await setDoc(doc(db, "schedules", day), { day, members: selectedMembers }); schedule[day] = selectedMembers; displaySchedule(); closeModal(editScheduleModal); showNotification(`Jadwal untuk hari ${day} berhasil disimpan.`, "success"); } catch (err) { console.error("Error saving schedule:", err); showNotification("Gagal menyimpan jadwal", "error"); } finally { setLoading(modalConfirmScheduleButton, false); } }
        async function clearScheduleForDayAction(day) { /* ... (unchanged) ... */ setLoading(clearScheduleButton, true); try { await setDoc(doc(db, "schedules", day), { day, members: [] }); schedule[day] = []; displaySchedule(); showNotification(`Jadwal untuk hari ${day} dikosongkan.`, "success"); } catch (err) { console.error("Error clearing schedule:", err); showNotification("Gagal mengosongkan jadwal", "error"); } finally { setLoading(clearScheduleButton, false); } }
        function displaySchedule() { /* ... (unchanged) ... */ scheduleDisplay.innerHTML = ""; const daysOrder = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu", "Minggu"]; let hasSchedule = false; daysOrder.forEach(day => { if (schedule[day] && schedule[day].length > 0) { hasSchedule = true; const div = document.createElement("div"); const names = schedule[day].join(", ") || "<i>(Kosong)</i>"; div.innerHTML = `<strong>${day}:</strong> ${names}`; scheduleDisplay.appendChild(div); } }); if (!hasSchedule) { scheduleDisplay.innerHTML = "<div>Belum ada jadwal yang diatur.</div>"; } }

        /***********************************************************************
         *     8) ABSENSI / KEHADIRAN (Unchanged)                             *
         ***********************************************************************/
        function showAttendanceForm() { /* ... (unchanged) ... */ const selectedDate = attendanceDateInput.value; if (!selectedDate || !/^\d{4}-\d{2}-\d{2}$/.test(selectedDate)) { showNotification("Pilih tanggal valid.", "warning"); attendanceMarkingDiv.classList.remove('visible'); return; } const dateObj = new Date(selectedDate + "T00:00:00"); if (isNaN(dateObj.getTime())) { showNotification("Tanggal tidak valid.", "error"); attendanceMarkingDiv.classList.remove('visible'); return; } const dayIndex = dateObj.getDay(); const dayName = daysInIndonesian[dayIndex]; selectedDateDisplay.textContent = selectedDate; selectedDayDisplay.textContent = dayName; attendanceCheckboxesDiv.innerHTML = ""; attendanceStatusDiv.innerHTML = ""; saveAttendanceButton.style.display = "none"; noScheduleMessage.style.display = "none"; const scheduled = schedule[dayName] || []; const validScheduledMembers = scheduled.filter(m => members.includes(m)); if (validScheduledMembers.length === 0) { noScheduleMessage.style.display = "block"; attendanceCheckboxesDiv.innerHTML = "<p>Tidak ada jadwal piket.</p>"; } else { saveAttendanceButton.style.display = "inline-flex"; const existingAttendance = attendance[selectedDate] || {}; validScheduledMembers.forEach(member => { const record = existingAttendance[member] || { present: false, reason: "" }; const isPresent = record.present; const currentReason = record.reason || ""; const itemDiv = document.createElement("div"); itemDiv.classList.add("attendance-item"); itemDiv.classList.toggle('show-reason', !isPresent); const labelEl = document.createElement("label"); const checkbox = document.createElement("input"); checkbox.type = "checkbox"; checkbox.value = member; checkbox.checked = isPresent; checkbox.classList.add("attendance-checkbox"); const safeMemberId = member.replace(/[^a-zA-Z0-9-_]/g, ""); checkbox.id = `att-${selectedDate}-${safeMemberId}`; labelEl.htmlFor = checkbox.id; labelEl.appendChild(checkbox); labelEl.appendChild(document.createTextNode(" " + member)); const reasonInput = document.createElement("input"); reasonInput.type = "text"; reasonInput.value = currentReason; reasonInput.placeholder = "Alasan..."; reasonInput.classList.add("reason-input"); itemDiv.appendChild(labelEl); itemDiv.appendChild(reasonInput); attendanceCheckboxesDiv.appendChild(itemDiv); }); displayAttendanceStatus(selectedDate, dayName); } attendanceMarkingDiv.classList.add('visible'); }
        function handleAttendanceCheckboxChange(event) { /* ... (unchanged) ... */ if (event.target.type === "checkbox" && event.target.classList.contains("attendance-checkbox")) { const itemDiv = event.target.closest(".attendance-item"); if (itemDiv) { itemDiv.classList.toggle('show-reason', !event.target.checked); if (event.target.checked) { const reasonInput = itemDiv.querySelector(".reason-input"); if(reasonInput) reasonInput.value = ""; } } } }
        async function saveAttendance() { /* ... (unchanged) ... */ const selectedDate = attendanceDateInput.value; if (!selectedDate || !/^\d{4}-\d{2}-\d{2}$/.test(selectedDate)) { showNotification("Tanggal tidak valid.", "error"); return; } const dateObj = new Date(selectedDate + "T00:00:00"); if (isNaN(dateObj.getTime())) { showNotification("Tanggal tidak valid.", "error"); return; } const dayName = daysInIndonesian[dateObj.getDay()]; const scheduled = schedule[dayName] || []; const newRecords = {}; const items = attendanceCheckboxesDiv.querySelectorAll(".attendance-item"); items.forEach(item => { const checkbox = item.querySelector(".attendance-checkbox"); const reasonInput = item.querySelector(".reason-input"); const memberName = checkbox.value; if (scheduled.includes(memberName)) { const isPresent = checkbox.checked; const reason = isPresent ? "" : reasonInput.value.trim(); newRecords[memberName] = { present: isPresent, reason: reason }; } }); setLoading(saveAttendanceButton, true); try { const docRef = doc(db, "attendance", selectedDate); if (Object.keys(newRecords).length === 0) { try { await deleteDoc(docRef); delete attendance[selectedDate]; showNotification(`Absensi ${selectedDate} dihapus (kosong).`, "info"); } catch (delErr) { if (delErr.code !== 'not-found') throw delErr; else console.log("Attendance doc to delete not found."); delete attendance[selectedDate]; } } else { await setDoc(docRef, { date: selectedDate, records: newRecords }); attendance[selectedDate] = newRecords; showNotification(`Kehadiran ${selectedDate} disimpan.`, "success"); } displayAttendanceStatus(selectedDate, dayName); populateAwardMonthSelect(); /* Refresh months after saving */ } catch (err) { console.error("Error saving attendance:", err); showNotification("Gagal menyimpan kehadiran", "error"); } finally { setLoading(saveAttendanceButton, false); } }
        function displayAttendanceStatus(selectedDate, dayName) { /* ... (unchanged) ... */ attendanceStatusDiv.innerHTML = ""; const scheduled = schedule[dayName] || []; const validScheduled = scheduled.filter(m => members.includes(m)); const attData = attendance[selectedDate] || {}; if (validScheduled.length === 0) { attendanceStatusDiv.innerHTML = "<p>Tidak ada jadwal valid.</p>"; return; } attendanceStatusDiv.innerHTML = `<strong>Status ${selectedDate} (${dayName}):</strong>`; const presentUl = document.createElement("ul"); const absentUl = document.createElement("ul"); let presentCount = 0; let absentCount = 0; validScheduled.forEach(member => { const li = document.createElement("li"); const record = attData[member] || { present: false, reason: "" }; li.textContent = member; if (record.present) { li.classList.add("present"); li.textContent += " (Piket)"; presentUl.appendChild(li); presentCount++; } else { li.classList.add("absent"); li.textContent += " (Tidak Piket)"; if (record.reason) { const reasonSpan = document.createElement("span"); reasonSpan.classList.add("reason-text"); reasonSpan.textContent = `- ${record.reason}`; li.appendChild(reasonSpan); } absentUl.appendChild(li); absentCount++; } }); const summary = document.createElement("p"); summary.innerHTML = `Total Piket: <span class="present">${presentCount}</span>, Tidak Piket: <span class="absent">${absentCount}</span>`; attendanceStatusDiv.appendChild(summary); if (presentUl.hasChildNodes()) { const presentHeader = document.createElement("strong"); presentHeader.textContent = "Hadir (Piket):"; presentHeader.style.color = "var(--success-green)"; attendanceStatusDiv.appendChild(presentHeader); attendanceStatusDiv.appendChild(presentUl); } if (absentUl.hasChildNodes()) { const absentHeader = document.createElement("strong"); absentHeader.textContent = "Tidak Hadir (Tidak Piket):"; absentHeader.style.color = "var(--danger-red)"; absentHeader.style.display = "block"; absentHeader.style.marginTop = "10px"; attendanceStatusDiv.appendChild(absentHeader); attendanceStatusDiv.appendChild(absentUl); } }


        /***********************************************************************
         *     9) PENGHARGAAN BULANAN (NEW FUNCTIONS)                        *
         ***********************************************************************/
         function populateAwardMonthSelect() {
             const months = new Set();
             Object.keys(attendance).forEach(date => {
                 if (/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                     months.add(date.substring(0, 7)); // Extract YYYY-MM
                 }
             });

             const sortedMonths = Array.from(months).sort().reverse(); // Sort newest first

             // Clear previous options except the placeholder
             awardMonthSelect.innerHTML = '<option value="">-- Pilih Bulan --</option>';

             sortedMonths.forEach(monthYYYYMM => {
                 const [year, month] = monthYYYYMM.split('-');
                 const monthName = monthNamesIndonesian[parseInt(month, 10) - 1];
                 const option = document.createElement('option');
                 option.value = monthYYYYMM; // Store YYYY-MM
                 option.textContent = `${monthName} ${year}`;
                 awardMonthSelect.appendChild(option);
             });

             if (sortedMonths.length === 0) {
                  awardMonthSelect.disabled = true;
                  calculateAwardButton.disabled = true;
                  awardResultDisplay.innerHTML = '<p><i>Belum ada data kehadiran untuk menentukan penghargaan bulanan.</i></p>';
             } else {
                  awardMonthSelect.disabled = false;
                  calculateAwardButton.disabled = false; // Enable button if months exist
                  awardResultDisplay.innerHTML = '<p><i>Pilih bulan dan klik tombol untuk melihat penerima penghargaan.</i></p>'; // Reset display text
             }
         }

         function calculateMonthlyAward() {
             const selectedMonth = awardMonthSelect.value; // YYYY-MM
             if (!selectedMonth) {
                 showNotification("Silakan pilih bulan terlebih dahulu.", "warning");
                 awardResultDisplay.innerHTML = '<p style="color: orange;">Pilih bulan dari daftar di atas.</p>';
                 return;
             }

             setLoading(calculateAwardButton, true);
             awardResultDisplay.innerHTML = '<p><i>Menghitung data...</i></p>';

             const monthlyCounts = {};
             let totalAttendanceInMonth = 0;

             // Iterate through attendance data
             Object.keys(attendance).forEach(date => {
                 if (date.startsWith(selectedMonth)) {
                     const dailyRecords = attendance[date];
                     if (dailyRecords) {
                         Object.keys(dailyRecords).forEach(memberName => {
                             // IMPORTANT: Only count active members
                             if (members.includes(memberName)) {
                                 if (dailyRecords[memberName].present === true) {
                                     monthlyCounts[memberName] = (monthlyCounts[memberName] || 0) + 1;
                                     totalAttendanceInMonth++;
                                 }
                             }
                         });
                     }
                 }
             });

             let maxAttendance = 0;
             let winners = [];

             if (totalAttendanceInMonth === 0) {
                  awardResultDisplay.innerHTML = `<p>Tidak ada data kehadiran yang tercatat untuk bulan ${awardMonthSelect.options[awardMonthSelect.selectedIndex].text}.</p>`;
                  setLoading(calculateAwardButton, false);
                  return;
             }

             // Find the max attendance count
             Object.values(monthlyCounts).forEach(count => {
                 if (count > maxAttendance) {
                     maxAttendance = count;
                 }
             });

             // Find all members with the max count
             Object.keys(monthlyCounts).forEach(memberName => {
                 if (monthlyCounts[memberName] === maxAttendance) {
                     winners.push(memberName);
                 }
             });

             // Display result
             const [year, month] = selectedMonth.split('-');
             const monthName = monthNamesIndonesian[parseInt(month, 10) - 1];
             if (winners.length > 0) {
                 const winnerText = winners.join(', ');
                 awardResultDisplay.innerHTML = `
                     <p>Penghargaan Bulan <strong>${monthName} ${year}</strong>:</p>
                     <p class="winner"><i class="fa-solid fa-star"></i> ${winnerText}</p>
                     <p>Dengan total kehadiran: <strong>${maxAttendance} kali</strong>.</p>
                 `;
                 showNotification(`Penghargaan ${monthName} ${year} diberikan kepada ${winnerText}.`, "success");
             } else {
                 // This case should be covered by totalAttendanceInMonth check, but as a fallback:
                 awardResultDisplay.innerHTML = `<p>Tidak ditemukan data kehadiran untuk anggota aktif di bulan ${monthName} ${year}.</p>`;
             }

             setLoading(calculateAwardButton, false);
         }


        /***********************************************************************
         *     10) LAPORAN PARTISIPASI (Terminology Changed)                  *
         ***********************************************************************/
        async function generateReport() {
            setLoading(generateReportButton, true);
            reportDisplay.innerHTML = "<p>Memproses laporan...</p>";
            await new Promise(resolve => setTimeout(resolve, 50)); // Allow UI update

            try {
                if (members.length === 0) { reportDisplay.innerHTML = "<p>Tidak ada anggota OSIS untuk dilaporkan.</p>"; return; }
                const hasSchedule = Object.keys(schedule).some(day => schedule[day]?.length > 0);
                const hasAttendance = Object.keys(attendance).length > 0;
                if (!hasSchedule && !hasAttendance) { reportDisplay.innerHTML = "<p>Belum ada data jadwal atau kehadiran yang cukup.</p>"; return; }

                const memberStats = {};
                // Initialize stats only for *current* members
                members.forEach(m => (memberStats[m] = { scheduled: 0, attended: 0 }));
                let totalPiketOpportunitiesRecorded = 0;

                // Iterate through attendance records
                for (const date in attendance) {
                    const dateObj = new Date(date + "T00:00:00");
                    if (isNaN(dateObj.getTime())) continue; // Skip invalid dates
                    const dayName = daysInIndonesian[dateObj.getDay()];
                    const scheduledMembersOnDate = schedule[dayName] || [];
                    const dailyRecord = attendance[date];

                    // Process only members who were scheduled AND are still active
                    scheduledMembersOnDate.forEach(member => {
                        if (memberStats[member] && dailyRecord && dailyRecord[member] !== undefined) {
                            memberStats[member].scheduled++;
                            totalPiketOpportunitiesRecorded++;
                            if (dailyRecord[member].present === true) {
                                memberStats[member].attended++;
                            }
                        }
                    });
                }

                if (totalPiketOpportunitiesRecorded === 0) { reportDisplay.innerHTML = "<p>Belum ada data kehadiran relevan dengan jadwal tersimpan.</p>"; return; }

                // Map to report array, calculate percentage
                const reportDataArray = members.map(member => {
                    const stats = memberStats[member];
                    const percentage = stats.scheduled > 0 ? (stats.attended / stats.scheduled) * 100 : 0;
                    return { name: member, attended: stats.attended, scheduled: stats.scheduled, percentage: percentage };
                });

                // Sort: Percentage DESC, Attended DESC, Name ASC
                reportDataArray.sort((a, b) => {
                    if (b.percentage !== a.percentage) return b.percentage - a.percentage;
                    if (b.attended !== a.attended) return b.attended - a.attended;
                    return a.name.localeCompare(b.name);
                });

                // Display report
                reportDisplay.innerHTML = ""; // Clear previous
                displayReportSummary(reportDataArray); // Display NEW summary

                reportDataArray.forEach(item => {
                    const div = document.createElement("div"); div.classList.add("report-item");
                    const nameSpan = document.createElement("span"); nameSpan.textContent = item.name + ": "; nameSpan.style.fontWeight = "bold";
                    const statsSpan = document.createElement("span"); statsSpan.innerHTML = `Hadir <strong>${item.attended}</strong> dari <strong>${item.scheduled}</strong> kali piket tercatat.`;
                    div.appendChild(nameSpan); div.appendChild(statsSpan);
                    if (item.scheduled > 0) {
                        const barContainer = document.createElement("div"); barContainer.classList.add("report-bar-container");
                        const bar = document.createElement("div"); bar.classList.add("report-bar");
                        requestAnimationFrame(() => { bar.style.width = item.percentage + "%"; });
                        if (item.percentage < 50) bar.classList.add("low"); // Keep visual cue
                        const pctSpan = document.createElement("span"); pctSpan.classList.add("report-text"); pctSpan.textContent = `(${item.percentage.toFixed(1)}%)`;
                        barContainer.appendChild(bar); barContainer.appendChild(pctSpan); div.appendChild(barContainer);
                    } else {
                        const noData = document.createElement("span"); noData.classList.add("report-text"); noData.style.marginLeft = "10px"; noData.textContent = "(Tidak ada data piket tercatat)";
                        div.appendChild(noData);
                    }
                    reportDisplay.appendChild(div);
                });

            } catch (error) {
                console.error("Error generating report:", error);
                reportDisplay.innerHTML = "<p style='color:red;'>Terjadi kesalahan saat membuat laporan.</p>";
                showNotification("Gagal membuat laporan.", "error");
            } finally {
                setLoading(generateReportButton, false);
            }
        }

        // ** Updated Summary Display with New Terminology **
        function displayReportSummary(dataArr) {
            const filtered = dataArr.filter(m => m.scheduled > 0); // Only consider members with recorded schedules
            if (!filtered.length) return; // No relevant data

            const summaryDiv = document.createElement("div");
            summaryDiv.classList.add("report-summary");

            const highest = filtered[0];
            const lowest = filtered[filtered.length - 1];

            let html = `<span class="positive">✅ <strong>Partisipasi Terbaik:</strong> ${highest.name} (${highest.percentage.toFixed(1)}%)</span><br>`;

            // Show improvement needed only if there's more than one person with data and they are different
            if (filtered.length > 1 && highest.name !== lowest.name) {
                 html += `<span class="needs-improvement">📈 <strong>Perlu Peningkatan:</strong> ${lowest.name} (${lowest.percentage.toFixed(1)}%)</span>`;
            } else if (filtered.length === 1) {
                 html += `<span class="info">ℹ️ (Hanya satu anggota dengan data partisipasi)</span>`;
            } else { // Multiple people, but all have same stats or only one person exists
                 html += `<span class="info">ℹ️ (Beberapa anggota memiliki tingkat partisipasi yang sama atau data belum cukup)</span>`;
            }

            summaryDiv.innerHTML = html;
            if (reportDisplay.firstChild) {
                reportDisplay.insertBefore(summaryDiv, reportDisplay.firstChild);
            } else {
                reportDisplay.appendChild(summaryDiv);
            }
        }
        function exportReportToCSV() { /* ... (unchanged) ... */ const memberStats = {}; members.forEach(m => (memberStats[m] = { scheduled: 0, attended: 0 })); let hasRelevantData = false; for (const date in attendance) { const dateObj = new Date(date + "T00:00:00"); if (isNaN(dateObj.getTime())) continue; const dayName = daysInIndonesian[dateObj.getDay()]; const scheduledMembersOnDate = schedule[dayName] || []; const dailyRecord = attendance[date]; scheduledMembersOnDate.forEach(member => { if (memberStats[member] && dailyRecord[member] !== undefined) { memberStats[member].scheduled++; hasRelevantData = true; if (dailyRecord[member].present === true) { memberStats[member].attended++; } } }); } if (!hasRelevantData) { showNotification("Tidak ada data laporan relevan.", "warning"); return; } const reportDataArray = members.map(member => { const stats = memberStats[member]; const percentage = stats.scheduled > 0 ? (stats.attended / stats.scheduled) * 100 : 0; return { name: member, attended: stats.attended, scheduled: stats.scheduled, percentage: percentage }; }).sort((a, b) => { if (b.percentage !== a.percentage) return b.percentage - a.percentage; if (b.attended !== a.attended) return b.attended - a.attended; return a.name.localeCompare(b.name); }); let csvContent = "data:text/csv;charset=utf-8,"; csvContent += "Nama Anggota,Jadwal Tercatat,Hadir,Persentase Kehadiran (%)\r\n"; reportDataArray.forEach(row => { const safeName = `"${row.name.replace(/"/g, '""')}"`; const rowData = [ safeName, row.scheduled, row.attended, row.percentage.toFixed(1) ]; csvContent += rowData.join(",") + "\r\n"; }); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); const today = new Date().toISOString().slice(0, 10); link.setAttribute("download", `laporan_partisipasi_osis_${today}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); showNotification("Laporan CSV diunduh.", "success"); }


        /***********************************************************************
         *     11) BACKUP & RESTORE (Unchanged)                              *
         ***********************************************************************/
        function backupData() { /* ... (unchanged) ... */ setLoading(backupButton, true); try { const dataToBackup = { members: [...members], schedule: JSON.parse(JSON.stringify(schedule)), attendance: JSON.parse(JSON.stringify(attendance)), backupDate: new Date().toISOString() }; const jsonString = JSON.stringify(dataToBackup, null, 2); backupDataArea.value = jsonString; backupDataArea.select(); showNotification("Backup data (memori) dibuat.", "success"); } catch (err) { console.error("Error creating backup:", err); showNotification("Gagal membuat backup.", "error"); } finally { setLoading(backupButton, false); } }
        async function restoreData() { /* ... (unchanged) ... */ const backupJSON = restoreDataArea.value.trim(); if (!backupJSON) { showNotification("Area restore kosong.", "warning"); return; } setLoading(restoreButton, true); showNotification("Memulai restore...", "info"); try { const restoredData = JSON.parse(backupJSON); if (!Array.isArray(restoredData.members) || typeof restoredData.schedule !== 'object' || typeof restoredData.attendance !== 'object') { throw new Error("Format backup tidak valid."); } await resetAllDataAction(); const batcher = writeBatch(db); let writeCount = 0; restoredData.members.forEach(memberName => { if (typeof memberName === 'string' && memberName.trim()) { const newMemberRef = doc(collection(db, "members")); batcher.set(newMemberRef, { name: memberName.trim() }); writeCount++; } }); for (const day in restoredData.schedule) { if (daysInIndonesian.includes(day) && Array.isArray(restoredData.schedule[day])) { const scheduleRef = doc(db, "schedules", day); batcher.set(scheduleRef, { day: day, members: restoredData.schedule[day] }); writeCount++; } } for (const date in restoredData.attendance) { if (/^\d{4}-\d{2}-\d{2}$/.test(date) && typeof restoredData.attendance[date] === 'object') { const attendanceRef = doc(db, "attendance", date); const validRecords = migrateAttendanceObject(restoredData.attendance[date]); if (Object.keys(validRecords).length > 0) { batcher.set(attendanceRef, { date: date, records: validRecords }); writeCount++; } } } if (writeCount > 490) { console.warn("Operasi restore mendekati limit."); } await batcher.commit(); await loadAllData(); displayMembers(modalMemberSearchInput.value); displaySchedule(); populateAwardMonthSelect(); /* Refresh months */ attendanceMarkingDiv.classList.remove('visible'); attendanceStatusDiv.innerHTML = ""; reportDisplay.innerHTML = ""; restoreDataArea.value = ""; showNotification("Restore data berhasil!", "success"); } catch (err) { console.error("Error during restore:", err); showNotification(`Gagal restore: ${err.message}.`, "error"); } finally { setLoading(restoreButton, false); } }
        async function resetAllData(askConfirm = true) { /* ... (unchanged) ... */ if (askConfirm) { showConfirmationModal('Konfirmasi Reset Aplikasi', `<strong>PERINGATAN KERAS!</strong> Anda akan <strong>MENGHAPUS SEMUA</strong> data di Firestore.<br>Tindakan ini tidak dapat dibatalkan. Yakin?`, () => resetAllDataAction(), 'danger'); } else { await resetAllDataAction(); } }
        async function resetAllDataAction() { /* ... (unchanged) ... */ setLoading(resetButton, true); showNotification("Memulai reset Firestore...", "info"); try { const collectionsToDelete = ["members", "schedules", "attendance"]; const batcher = writeBatch(db); let deleteCount = 0; for (const collName of collectionsToDelete) { const snapshot = await getDocs(collection(db, collName)); snapshot.forEach(docSnap => { batcher.delete(docSnap.ref); deleteCount++; }); } if (deleteCount > 0) { await batcher.commit(); } members = []; schedule = {}; attendance = {}; displayMembers(); displaySchedule(); populateAwardMonthSelect(); attendanceMarkingDiv.classList.remove('visible'); attendanceStatusDiv.innerHTML = ""; reportDisplay.innerHTML = ""; backupDataArea.value = ""; restoreDataArea.value = ""; showNotification("Reset Firestore berhasil.", "success"); } catch (err) { console.error("Error resetting data:", err); showNotification("Gagal mereset Firestore", "error"); } finally { setLoading(resetButton, false); } }


        /***********************************************************************
         *     12) INIT (Unchanged)                                           *
         ***********************************************************************/
        initializeAppMainApp();

    </script>

</body>
</html>
